<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Midjourney Prompt Builder</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 { font-size: 2rem; margin-bottom: 8px; }
    .header .sub-title { opacity: 0.9; font-size: 0.95rem; }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }

    .section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      min-width: 0;
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.3rem;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group { margin-bottom: 20px; }

    label {
      display: block;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s;
      max-width: 100%;
      background: #fff;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      padding: 14px 18px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      touch-action: manipulation;
      min-width: 160px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }

    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }

    .btn-light { background: #e9ecef; color: #333; }
    .btn-light:hover { background: #dde2e6; }

    .btn-danger{
      background:#ef4444;
      color:#fff;
      border:none;
    }
    .btn-danger:hover{ opacity:.9; }

    /* JSON modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.5);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:9999;
    }
    .modal{
      background:#fff;
      width:min(900px, 96vw);
      border-radius:14px;
      padding:16px;
      box-shadow:0 10px 35px rgba(0,0,0,.25);
    }
    .modal h3{ margin:0 0 10px 0; font-size:16px; }
    .modal textarea{
      width:100%;
      height:280px;
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }
    .modal .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }

    .output-editor {
      background: #fff;
      border: 2px solid #667eea;
      border-radius: 12px;
      padding: 12px;
      min-height: 170px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95rem;
      line-height: 1.6;
      color: #333;

      overflow-x: auto;
      overflow-y: auto;
      max-height: 260px;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-word;
      -webkit-overflow-scrolling: touch;
      resize: vertical;
    }

    .preset-list {
      max-height: 400px;
      overflow-y: auto;
      overflow-x: hidden;
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      -webkit-overflow-scrolling: touch;
    }

    .preset-item {
      padding: 12px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid #667eea;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .preset-item:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    .preset-item h4 {
      color: #667eea;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    .preset-item p {
      color: #666;
      font-size: 0.85rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .preset-memo{ font-size:12px; color:#6b7280; margin-top:4px; }

    .preset-item-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .preset-main { min-width: 0; }
    .preset-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: none;
    }
    .preset-btn {
      border: none;
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 0.95rem;
      line-height: 1;
    }
    .preset-btn:active { transform: scale(0.98); }
    .preset-btn.danger { border-color: #ffc9c9; }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      animation: slideIn 0.3s;
      max-width: min(520px, calc(100vw - 40px));
      line-height: 1.4;
    }
    .toast.error { background: #dc3545; }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .param-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .small-text {
      font-size: 0.8rem;
      color: #888;
      margin-top: 5px;
    }

    input[type="text"] {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .pill-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .pill {
      padding: 10px 12px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .pill input[type="radio"] { width: 18px; height: 18px; }
    .pill strong { font-size: 0.9rem; }

    .divider {
      height: 1px;
      background: #dde2e6;
      margin: 18px 0;
      border-radius: 999px;
    }

    .copy-helper {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      width: min(920px, calc(100vw - 24px));
      background: rgba(20, 20, 20, 0.92);
      color: #fff;
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      z-index: 1200;
      display: none;
    }

    .copy-helper .row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .copy-helper .title {
      font-weight: 800;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }
    .copy-helper .desc {
      opacity: 0.95;
      line-height: 1.35;
      font-size: 0.9rem;
    }

    .copy-helper button {
      flex: none;
      min-width: auto;
      padding: 10px 12px;
      font-size: 0.9rem;
      border-radius: 10px;
      background: #fff;
      color: #111;
    }
    .copy-helper button:hover { background: #f1f3f5; }

    @media (max-width: 1024px) {
      .main-content { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.5rem; }
      .param-grid { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      body { padding: 10px; }
      .main-content { padding: 15px; gap: 15px; }
      .section { padding: 15px; }
      .output-editor { max-height: 320px; }
      button { min-width: 100%; }
    }
  
    .preset-search{
      display:flex;
      gap:8px;
      align-items:center;
      margin: 6px 0 12px 0;
    }
    .preset-search input{
      flex: 1 1 auto;
      min-width: 0;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 0.95rem;
      background: #fff;
    }
    .preset-search input:focus{
      outline:none;
      border-color:#667eea;
    }
    .preset-clear{
      flex: 0 0 44px;
      width: 44px;
      height: 44px;
      min-width: 44px;
      padding: 0;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      background: #fff;
      cursor:pointer;
      font-size: 1.3rem;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Mobile fix: keep search input wide and clear button contained */
    @media (max-width: 600px){
      .preset-search{
        gap: 6px;
      }
      .preset-search input{
        padding: 12px 12px;
        font-size: 1rem;
      }
      .preset-clear{
        flex: 0 0 44px;
        width: 44px;
        height: 44px;
        min-width: 44px;
      }
    }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Midjourney Prompt Builder</h1>
      <div class="sub-title">Midjourneyãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ„ãƒ¼ãƒ«</div>
    </div>

    <div class="main-content">
      <!-- å·¦å´ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="section">
        <h2>ğŸ“ Prompt Settings / ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</h2>

        <div class="form-group">
          <label for="theme">Theme / ãƒ†ãƒ¼ãƒ</label>
          <input type="text" id="theme" placeholder="ä¾‹: a cyberpunk warrior in neon city" />
        </div>

        <div class="form-group">
          <label for="personTemplate">Person Template / äººç‰©ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
          <select id="personTemplate">
            <option value="">ãªã— / None</option>
            <option value="beautiful young woman, detailed face, expressive eyes">Beautiful Young Woman</option>
            <option value="handsome man, sharp jawline, confident expression">Handsome Man</option>
            <option value="elderly person, wise expression, wrinkled face">Elderly Person</option>
            <option value="child, innocent eyes, playful expression">Child</option>
            <option value="fantasy character, unique features, mystical appearance">Fantasy Character</option>
            <option value="custom">Custom / è‡ªç”±å…¥åŠ›â€¦</option>
          </select>
          <div id="personTemplateCustomWrap" style="display:none; margin-top:8px;">
            <input id="personTemplateCustom" type="text" placeholder="ä¾‹: a realistic young japanese woman, detailed facial features" style="width:100%;">
          </div>
        </div>

        <div class="param-grid">
          <div class="form-group">
            <label for="composition">Composition / æ§‹å›³</label>
            <select id="composition">
              <option value="close-up shot">Close-up</option>
              <option value="portrait shot">Portrait</option>
              <option value="mid-body shot">Mid-body</option>
              <option value="full-body shot">Full-body</option>
              <option value="custom">Custom / è‡ªç”±å…¥åŠ›â€¦</option>
            </select>
            <div id="compositionCustomWrap" style="display:none; margin-top:8px;">
              <input id="compositionCustom" type="text" placeholder="ä¾‹: close-up shot / mid-body shot / full-body shot" style="width:100%;">
            </div>
          </div>

          <div class="form-group">
            <label for="angle">Angle / ã‚¢ãƒ³ã‚°ãƒ«</label>
            <select id="angle">
              <option value="front view">Front</option>
              <option value="three-quarter view">Three-quarter</option>
              <option value="side view">Side</option>
              <option value="over-shoulder view">Over-shoulder</option>
              <option value="custom">Custom / è‡ªç”±å…¥åŠ›â€¦</option>
            </select>
            <div id="angleCustomWrap" style="display:none; margin-top:8px;">
              <input id="angleCustom" type="text" placeholder="ä¾‹: three-quarter view / low angle / top-down" style="width:100%;">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="lighting">Lighting / ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°</label>
          <select id="lighting">
            <option value="soft window light">Soft Window Light</option>
            <option value="neon rim lighting">Neon Rim Lighting</option>
            <option value="cinematic key light">Cinematic Key Light</option>
            <option value="studio beauty lighting">Studio Beauty Lighting</option>
            <option value="custom">Custom / è‡ªç”±å…¥åŠ›â€¦</option>
          </select>
          <div id="lightingCustomWrap" style="display:none; margin-top:8px;">
            <input id="lightingCustom" type="text" placeholder="ä¾‹: soft window light / neon rim lighting / cinematic lighting" style="width:100%;">
          </div>
        </div>

        <div class="form-group">
          <label for="background">Background / èƒŒæ™¯</label>
          <select id="background">
            <option value="city night background">City Night</option>
            <option value="minimal studio background">Minimal Studio</option>
            <option value="cafe street background">Cafe Street</option>
            <option value="custom">Custom / è‡ªç”±å…¥åŠ›â€¦</option>
          </select>
          <div id="backgroundCustomWrap" style="display:none; margin-top:8px;">
            <input id="backgroundCustom" type="text" placeholder="ä¾‹: city night background / studio backdrop / shrine at night" style="width:100%;">
          </div>
        </div>

        <h2 style="margin-top: 30px;">âš™ï¸ Midjourney Parameters / Midjourneyãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h2>

        <div class="form-group" style="margin-top:10px;">
          <label for="fixedTail">Fixed Tail / å›ºå®šè¿½è¨˜ï¼ˆä»»æ„ï¼‰</label>
          <input id="fixedTail" type="text" placeholder="ä¾‹: cinematic film grain, ultra-detailed texturesï¼ˆâ€»æœ¬æ–‡å´ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼‰" />
        </div>

        <!-- ã“ã“ã¯æ®‹ã™ï¼šè‡ªç”±å…¥åŠ›ï¼ˆè‡ªå‹•ã§ --no ã¯ä»˜ä¸ã—ãªã„ï¼‰ -->
        <div class="form-group" style="margin-top:10px;">
          <label for="negative">Exclude (optional) / é™¤å¤–ï¼ˆä»»æ„ï¼‰</label>
          <input id="negative" type="text" placeholder="ä¾‹: --no text, watermark, logo" />
        </div>

        <div class="param-grid">
          <div class="form-group">
            <label for="ar">--ar / ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”</label>
            <select id="ar">
              <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
              <option value="16:9">16:9 (æ¨ªé•·)</option>
              <option value="9:16" selected>9:16 (ç¸¦é•·)</option>
              <option value="4:3">4:3</option>
              <option value="3:2">3:2</option>
              <option value="2:3">2:3</option>
              <option value="custom">Custom</option>
            </select>

            <div class="form-group" id="arCustomWrap" style="display:none; margin-top:10px;">
              <label for="arCustom">ã‚«ã‚¹ã‚¿ãƒ æ¯”ç‡ï¼ˆä¾‹: 7:10ï¼‰</label>
              <input type="text" id="arCustom" placeholder="ä¾‹: 7:10" />
              <div class="small-text">å½¢å¼ã¯ã€Œæ•°å­—:æ•°å­—ã€</div>
            </div>
          </div>

          <div class="form-group">
            <label for="stylize">--stylize / ã‚¹ã‚¿ã‚¤ãƒ©ã‚¤ã‚º</label>
            <input type="number" id="stylize" min="0" max="1000" value="100" step="50" />
            <div class="small-text">0-1000 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100)</div>
          </div>

          <div class="form-group">
            <label for="chaos">--chaos / ã‚«ã‚ªã‚¹</label>
            <input type="number" id="chaos" min="0" max="100" value="0" step="10" />
            <div class="small-text">0-100 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0)</div>
          </div>

          <div class="form-group">
            <label for="quality">--quality / å“è³ª</label>
            <select id="quality">
              <option value="0.25">0.25 (ä½é€Ÿ)</option>
              <option value="0.5">0.5</option>
              <option value="1" selected>1 (æ¨™æº–)</option>
              <option value="2">2 (é«˜å“è³ª)</option>
            </select>
          </div>
        </div>

        <!-- RAW è¡¨è¨˜åˆ‡æ›¿ï¼ˆ--style raw / --rawï¼‰ -->
        <div class="form-group">
          <label>RAW Mode (toggle) / RAWè¡¨è¨˜ï¼ˆåˆ‡æ›¿ï¼‰</label>
          <div class="pill-row" role="radiogroup" aria-label="RAW Mode toggle / RAWè¡¨è¨˜åˆ‡æ›¿">
            <label class="pill" for="rawStyle">
              <input type="radio" name="rawMode" id="rawStyle" value="style" checked />
              <strong>--style raw</strong>
            </label>
            <label class="pill" for="rawRaw">
              <input type="radio" name="rawMode" id="rawRaw" value="raw" />
              <strong>--raw</strong>
            </label>
          </div>
          <div class="checkbox-group" style="margin-top: 10px;">
            <input type="checkbox" id="raw" />
            <label for="raw" style="margin-bottom: 0;">Enable RAW mode / RAWãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–</label>
          </div>
          <div class="small-text">Midjourney may auto-convert this (either is OK) / Midjourneyå´ã§è‡ªå‹•å¤‰æ›ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆã©ã¡ã‚‰ã§ã‚‚OKï¼‰ã€‚</div>
        </div>

        <div class="form-group">
          <label for="seed">--seed (optional) / ã‚·ãƒ¼ãƒ‰</label>
          <input type="number" id="seed" placeholder="ä¾‹: 12345" />
          <div class="small-text">Consistent results with the same seed / åŒã˜ã‚·ãƒ¼ãƒ‰ã§ä¸€è²«ã—ãŸçµæœ</div>
        </div>

        <div class="form-group">
          <label for="sref">--sref (optional) / ã‚¹ã‚¿ã‚¤ãƒ«å‚ç…§</label>
          <input type="text" id="sref" placeholder="Image URL / ç”»åƒURL" />
          <div class="small-text">Style reference image URL / ã‚¹ã‚¿ã‚¤ãƒ«å‚ç…§ç”»åƒã®URL</div>
        </div>

        <div class="form-group">
          <label for="cref">--cref (optional) / ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‚ç…§</label>
          <input type="text" id="cref" placeholder="Image URL / ç”»åƒURL" />
          <div class="small-text">Character reference image URL / ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‚ç…§ç”»åƒã®URL</div>
        </div>

        <div class="divider"></div>

        <div class="button-group">
          <button class="btn-primary" type="button" id="btnGenerate">âœ¨ Generate / ç”Ÿæˆ</button>
          <button class="btn-success" type="button" id="btnSave">ğŸ’¾ Save / Update / ä¿å­˜ãƒ»æ›´æ–°</button>
          <button class="btn-danger" type="button" id="btnClear">ğŸ§¹ Clear / ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="small-text" style="margin-top:8px;">
          â€» Save creates a new preset; if the same name exists, it overwrites. / Saveã¯æ–°è¦ä¿å­˜ã€‚ã™ã§ã«åŒåãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãæ›´æ–°ã—ã¾ã™ã€‚
        </div>
      </div>

      <!-- å³å´ï¼šå‡ºåŠ›ã¨ãƒ—ãƒªã‚»ãƒƒãƒˆ -->
      <div class="section">
        <h2>ğŸ¯ Generated Prompt (Editable) / ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆç·¨é›†OKï¼‰</h2>

        <textarea class="output-editor" id="outputEditor" spellcheck="false">ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</textarea>

        <div class="button-group">
          <button class="btn-secondary" type="button" id="btnCopy">ğŸ“‹ Copy / ã‚³ãƒ”ãƒ¼</button>
          <button class="btn-light" type="button" id="btnRebuild">ğŸ§© Rebuild / å†ç”Ÿæˆ</button>
        </div>

        <div class="small-text" style="margin-top: 8px;">
          â€» Copy copies the text in this editor. / Copyã¯ã“ã®ç·¨é›†æ¬„ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚<br>
          â€» Rebuild regenerates from the left settings and overwrites this editor. / Rebuildã¯å·¦ã®è¨­å®šã‹ã‚‰å†ç”Ÿæˆã—ã¦ã€ã“ã®æ¬„ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚
        </div>

        <h2 style="margin-top: 30px;">ğŸ“š Presets (tap to load / ğŸ—‘ to delete) / ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¿ãƒƒãƒ—ã§èª­ã¿è¾¼ã¿ / ğŸ—‘ã§å‰Šé™¤ï¼‰</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 12px 0;">
                    <button class="btn-secondary" type="button" id="btnImportFile">ğŸ“‚ Import / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button class="btn-secondary" type="button" id="btnExportFile">ğŸ’¾ Export / ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <input type="file" id="presetFileInput" accept="application/json" style="display:none;" />
        </div>
        
        <div class="preset-search">
          <input type="text" id="presetSearch" placeholder="Search / æ¤œç´¢ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆåãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰" />
          <button class="preset-clear" type="button" id="btnPresetSearchClear" title="ã‚¯ãƒªã‚¢">Ã—</button>
        </div>
<div class="preset-list" id="presetList"></div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="jsonBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="jsonModalTitle">Preset JSON</h3>
      <textarea id="jsonTextarea" spellcheck="false" placeholder="ã“ã“ã«JSONãŒè¡¨ç¤ºã•ã‚Œã¾ã™ / ã“ã“ã«JSONã‚’è²¼ã‚Šä»˜ã‘ã¦Import"></textarea>
      <div class="modal-actions">
        <button class="btn-light" type="button" id="btnJsonClose">Close / é–‰ã˜ã‚‹</button>
        <button class="btn-secondary" type="button" id="btnJsonCopy">Copy / ã‚³ãƒ”ãƒ¼</button>
        <button class="btn-primary" type="button" id="btnJsonApply">Import / Apply / åæ˜ </button>
      </div>
      <div class="small-text" style="margin-top:8px;">
        â€» Importã¯ã€ŒåŒåãªã‚‰ä¸Šæ›¸ãã€ã—ã¦å–ã‚Šè¾¼ã¿ã¾ã™ã€‚
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

  <div class="copy-helper" id="copyHelper" aria-live="polite">
    <div class="row">
      <div>
        <div class="title">ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆiPhone/Safariå¯¾ç­–ï¼‰</div>
        <div class="desc">å‡ºåŠ›æ¬„ã‚’é•·æŠ¼ã— â†’ å…¨é¸æŠ â†’ ã‚³ãƒ”ãƒ¼ ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ä»Šã€å‡ºåŠ›æ¬„ã‚’è‡ªå‹•ã§é¸æŠçŠ¶æ…‹ã«ã—ã¦ã„ã¾ã™ã€‚</div>
      </div>
      <button type="button" id="btnCopyHelpClose">Close / é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    // ===== ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆåˆæœŸã¯ç©ºï¼š20å€‹ã¯å…¥ã‚Œãªã„ï¼‰ =====
    const samplePresets = [
  { name:"Cyberpunk Portrait / ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"ãƒã‚ªãƒ³Ã—äººç‰©ã®å®šç•ªã€‚ç™ºå…‰ã‚¿ãƒˆã‚¥ãƒ¼ã‚„è¿‘æœªæ¥æ„Ÿã‚’å®‰å®šã•ã›ã‚‹ã€‚", theme:"cyberpunk warrior with glowing tattoos", personTemplate:"beautiful young woman, detailed face, expressive eyes", composition:"portrait shot", angle:"three-quarter view", lighting:"neon rim lighting", background:"city night background", ar:"9:16", stylize:150, chaos:20, quality:1, raw:true },
  { name:"Elegant Fashion / ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³", memo:"ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯ã§æœãƒ»ã‚·ãƒ«ã‚¨ãƒƒãƒˆé‡è¦–ã€‚å…¨èº«å†™çœŸé¢¨ã€‚", theme:"elegant fashion model in luxury dress", personTemplate:"beautiful young woman, detailed face, expressive eyes", composition:"full-body shot", angle:"front view", lighting:"studio beauty lighting", background:"minimal studio background", ar:"2:3", stylize:200, chaos:0, quality:2, raw:false },
  { name:"Business Leader / ãƒ“ã‚¸ãƒã‚¹ãƒªãƒ¼ãƒ€ãƒ¼", memo:"æ¸…æ½”æ„Ÿã‚ã‚‹äººç‰©ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆã€‚ã‚ªãƒ•ã‚£ã‚¹ç³»ã®ç´ æã¥ãã‚Šã«ã€‚", theme:"confident CEO in modern office", personTemplate:"handsome man, sharp jawline, confident expression", composition:"mid-body shot", angle:"three-quarter view", lighting:"cinematic key light", background:"minimal studio background", ar:"16:9", stylize:100, chaos:0, quality:1, raw:true },
  { name:"Fantasy Wizard / ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰", memo:"é­”æ³•æ¼”å‡ºï¼‹å¹´é…é¡”ã€‚ä¸–ç•Œè¦³ã®å¼·ã„äººç‰©ã«å¯„ã›ã‚‹ã€‚", theme:"powerful wizard casting spell", personTemplate:"elderly person, wise expression, wrinkled face", composition:"portrait shot", angle:"front view", lighting:"cinematic key light", background:"city night background", ar:"1:1", stylize:250, chaos:30, quality:1, raw:false },
  { name:"Street Portrait / ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"è¡—ã‚¹ãƒŠãƒƒãƒ—é¢¨ã€‚è‡ªç„¶å…‰å¯„ã‚Šã§â€œä½œã‚Šè¾¼ã¿ã™ããªã„â€äººç‰©ã€‚", theme:"urban street style photographer", personTemplate:"handsome man, sharp jawline, confident expression", composition:"mid-body shot", angle:"side view", lighting:"soft window light", background:"cafe street background", ar:"4:3", stylize:150, chaos:10, quality:1, raw:true },
  { name:"Natural Beauty / ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼", memo:"æŸ”ã‚‰ã‹ã„å…‰ã§è‚Œã¨è¡¨æƒ…ã‚’ãã‚Œã„ã«ã€‚ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—å‘ã‘ã€‚", theme:"natural beauty in sunlight", personTemplate:"beautiful young woman, detailed face, expressive eyes", composition:"close-up shot", angle:"three-quarter view", lighting:"soft window light", background:"minimal studio background", ar:"3:2", stylize:100, chaos:0, quality:2, raw:true },
  { name:"Child Smile / å­ä¾›ã®ç¬‘é¡”", memo:"æ˜ã‚‹ã„é›°å›²æ°—ã®å­ä¾›äººç‰©ã€‚å…¬åœ’ãƒ»æ—¥å¸¸ç³»ã«ã€‚", theme:"happy child playing in park", personTemplate:"child, innocent eyes, playful expression", composition:"portrait shot", angle:"front view", lighting:"soft window light", background:"cafe street background", ar:"1:1", stylize:100, chaos:0, quality:1, raw:false },
  { name:"Dark Hero / ãƒ€ãƒ¼ã‚¯ãƒ’ãƒ¼ãƒ­ãƒ¼", memo:"å½±ãƒ»é€†å…‰ã§ã‚·ãƒªã‚¢ã‚¹å¯„ã‚Šã€‚æ˜ ç”»é¢¨ã®äººç‰©ã«ã€‚", theme:"mysterious dark hero in shadows", personTemplate:"handsome man, sharp jawline, confident expression", composition:"full-body shot", angle:"three-quarter view", lighting:"neon rim lighting", background:"city night background", ar:"9:16", stylize:200, chaos:40, quality:1, raw:false },
  { name:"Elf Warrior / ã‚¨ãƒ«ãƒ•ã®æˆ¦å£«", memo:"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼äººç‰©ã®å®šç•ªã€‚å¼“ã‚„è£…å‚™ãŒæ˜ ãˆã‚‹ã€‚", theme:"elven warrior with bow and arrow", personTemplate:"fantasy character, unique features, mystical appearance", composition:"full-body shot", angle:"side view", lighting:"cinematic key light", background:"city night background", ar:"9:16", stylize:300, chaos:20, quality:1, raw:false },
  { name:"Cafe Girl / ã‚«ãƒ•ã‚§ã®å°‘å¥³", memo:"ã‚«ãƒ•ã‚§èƒŒæ™¯ï¼‹æŸ”ã‚‰ã‹ã„å…‰ã€‚SNSå‘ã‘äººç‰©ç´ æã«ã€‚", theme:"young woman reading book in cafe", personTemplate:"beautiful young woman, detailed face, expressive eyes", composition:"mid-body shot", angle:"over-shoulder view", lighting:"soft window light", background:"cafe street background", ar:"16:9", stylize:150, chaos:0, quality:1, raw:true },
  { name:"Ancient Sage / è€è³¢è€…", memo:"ã—ã‚ãƒ»å¹´é½¢è¡¨ç¾ã®ç¢ºèªç”¨ã€‚é¡”ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«é‡è¦–ã€‚", theme:"ancient sage with wisdom in eyes", personTemplate:"elderly person, wise expression, wrinkled face", composition:"close-up shot", angle:"front view", lighting:"cinematic key light", background:"minimal studio background", ar:"1:1", stylize:200, chaos:10, quality:2, raw:false },
  { name:"Action Hero / ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ’ãƒ¼ãƒ­ãƒ¼", memo:"å‹•ãã®ã‚ã‚‹äººç‰©ã‚’ä½œã‚‹ãƒ™ãƒ¼ã‚¹ã€‚ãƒãƒ¼ã‚ºæ¤œè¨¼ã«ã€‚", theme:"action hero in dynamic pose", personTemplate:"handsome man, sharp jawline, confident expression", composition:"full-body shot", angle:"three-quarter view", lighting:"cinematic key light", background:"city night background", ar:"16:9", stylize:150, chaos:30, quality:1, raw:true },
  { name:"Magical Girl / é­”æ³•å°‘å¥³", memo:"ç™ºå…‰è¡¨ç¾Ã—ã‚­ãƒ£ãƒ©æ„Ÿã®ç¢ºèªã€‚ãƒã‚ªãƒ³ç³»ã«å¼·ã„ã€‚", theme:"magical girl with glowing powers", personTemplate:"fantasy character, unique features, mystical appearance", composition:"portrait shot", angle:"front view", lighting:"neon rim lighting", background:"city night background", ar:"9:16", stylize:250, chaos:20, quality:1, raw:false },
  { name:"Professional Portrait / ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«", memo:"ãƒ“ã‚¸ãƒã‚¹ç”¨é€”ã®â€œã¡ã‚ƒã‚“ã¨ã—ãŸâ€äººç‰©ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸé¢¨ã€‚", theme:"professional business portrait", personTemplate:"beautiful young woman, detailed face, expressive eyes", composition:"portrait shot", angle:"front view", lighting:"studio beauty lighting", background:"minimal studio background", ar:"3:2", stylize:100, chaos:0, quality:2, raw:true },
  { name:"Samurai / ã‚µãƒ ãƒ©ã‚¤", memo:"å’Œé¢¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³äººç‰©ã€‚åˆ€ã‚„è¡£è£…ã®è¦‹ã›æ–¹ç¢ºèªã«ã€‚", theme:"samurai warrior with katana", personTemplate:"handsome man, sharp jawline, confident expression", composition:"full-body shot", angle:"side view", lighting:"cinematic key light", background:"minimal studio background", ar:"9:16", stylize:200, chaos:20, quality:1, raw:false },
  { name:"Angel / å¤©ä½¿", memo:"ç™½ãƒ»å…‰ãƒ»ç¿¼ã®è¡¨ç¾ç¢ºèªã€‚ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼äººç‰©ã«ã€‚", theme:"angel with glowing wings", personTemplate:"fantasy character, unique features, mystical appearance", composition:"full-body shot", angle:"front view", lighting:"soft window light", background:"minimal studio background", ar:"2:3", stylize:300, chaos:10, quality:1, raw:false },
  { name:"Rock Star / ãƒ­ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼", memo:"ã‚¹ãƒ†ãƒ¼ã‚¸å…‰ã®æ¼”å‡ºç¢ºèªã€‚æ´¾æ‰‹ãªäººç‰©ã‚«ãƒƒãƒˆå‘ã‘ã€‚", theme:"rock star performing on stage", personTemplate:"handsome man, sharp jawline, confident expression", composition:"mid-body shot", angle:"three-quarter view", lighting:"neon rim lighting", background:"city night background", ar:"16:9", stylize:200, chaos:30, quality:1, raw:false },
  { name:"Spy / ã‚¹ãƒ‘ã‚¤", memo:"ã‚¿ã‚¯ãƒ†ã‚£ã‚«ãƒ«è£…å‚™ï¼‹ç·Šå¼µæ„Ÿã€‚æ˜ ç”»ã‚¹ãƒãƒ«é¢¨ã«ã€‚", theme:"secret agent in tactical gear", personTemplate:"beautiful young woman, detailed face, expressive eyes", composition:"full-body shot", angle:"three-quarter view", lighting:"cinematic key light", background:"city night background", ar:"9:16", stylize:150, chaos:20, quality:1, raw:true },
  { name:"Dragon Rider / ãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼", memo:"é¨ä¹—ãƒ»é§ãƒ»é­”æ³•ã®äººç‰©å‘ã‘ã€‚è¿«åŠ›é‡è¦–ã®æ¤œè¨¼ç”¨ã€‚", theme:"dragon rider with magical armor", personTemplate:"fantasy character, unique features, mystical appearance", composition:"portrait shot", angle:"front view", lighting:"cinematic key light", background:"city night background", ar:"1:1", stylize:300, chaos:40, quality:1, raw:false },
  { name:"Cafe Owner / ã‚«ãƒ•ã‚§ã‚ªãƒ¼ãƒŠãƒ¼", memo:"æ—¥å¸¸äººç‰©ï¼ˆæ¥å®¢ï¼‰å‘ã‘ã€‚æ¸©ã‹ã„ç©ºæ°—æ„Ÿã®ç¢ºèªç”¨ã€‚", theme:"friendly cafe owner serving coffee", personTemplate:"elderly person, wise expression, wrinkled face", composition:"mid-body shot", angle:"over-shoulder view", lighting:"soft window light", background:"cafe street background", ar:"4:3", stylize:100, chaos:0, quality:1, raw:true }
];

    // ===== çŠ¶æ…‹ç®¡ç†ã‚­ãƒ¼ =====
    const KEY_PRESETS   = 'mjPresets';
    const KEY_LAST_STATE= 'mjLastState';
    const KEY_EDITOR    = 'mjOutputEditorText';
    const KEY_RAW_MODE  = 'mjRawMode'; // "style" | "raw"

    // ===== å®‰å…¨ãªJSON =====
    function safeParseJSON(raw, fallback){
      if (!raw) return fallback;
      try { return JSON.parse(raw); } catch { return fallback; }
    }

    
    // ===== ãƒ—ãƒªã‚»ãƒƒãƒˆåãƒ»ãƒ¡ãƒ¢ã®è‡ªå‹•è£œæ­£ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œï¼‰ =====
    // ç›®çš„ï¼šæ—¢å­˜ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆä¾‹:ã€Œãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼ã€ã€Œã‚«ãƒ•ã‚§ã‚ªãƒ¼ãƒŠãƒ¼ã€ï¼‰ã‚‚
    // ã€ŒEnglish Title / æ—¥æœ¬èªã‚µãƒ–ã€å½¢å¼ + memo ä»˜ãã«è‡ªå‹•å¤‰æ›ã™ã‚‹
    const PRESET_NAME_MAP = {
  "ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ": { en:"Cyberpunk Portrait", jp:"ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"ãƒã‚ªãƒ³Ã—äººç‰©ã®å®šç•ªã€‚ç™ºå…‰ã‚¿ãƒˆã‚¥ãƒ¼ã‚„è¿‘æœªæ¥æ„Ÿã‚’å®‰å®šã•ã›ã‚‹ã€‚" },
  "ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ": { en:"Cyberpunk Portrait", jp:"ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"ãƒã‚ªãƒ³Ã—äººç‰©ã®å®šç•ªã€‚ç™ºå…‰ã‚¿ãƒˆã‚¥ãƒ¼ã‚„è¿‘æœªæ¥æ„Ÿã‚’å®‰å®šã•ã›ã‚‹ã€‚" },
  "Cyberpunk Portrait / ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ": { en:"Cyberpunk Portrait", jp:"ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"ãƒã‚ªãƒ³Ã—äººç‰©ã®å®šç•ªã€‚ç™ºå…‰ã‚¿ãƒˆã‚¥ãƒ¼ã‚„è¿‘æœªæ¥æ„Ÿã‚’å®‰å®šã•ã›ã‚‹ã€‚" },
  "ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆ ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³": { en:"Elegant Fashion", jp:"ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³", memo:"ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯ã§æœãƒ»ã‚·ãƒ«ã‚¨ãƒƒãƒˆé‡è¦–ã€‚å…¨èº«å†™çœŸé¢¨ã€‚" },
  "Elegant Fashion / ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³": { en:"Elegant Fashion", jp:"ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³", memo:"ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯ã§æœãƒ»ã‚·ãƒ«ã‚¨ãƒƒãƒˆé‡è¦–ã€‚å…¨èº«å†™çœŸé¢¨ã€‚" },
  "ãƒ“ã‚¸ãƒã‚¹ ãƒªãƒ¼ãƒ€ãƒ¼": { en:"Business Leader", jp:"ãƒ“ã‚¸ãƒã‚¹ãƒªãƒ¼ãƒ€ãƒ¼", memo:"æ¸…æ½”æ„Ÿã‚ã‚‹äººç‰©ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆã€‚ã‚ªãƒ•ã‚£ã‚¹ç³»ã®ç´ æã¥ãã‚Šã«ã€‚" },
  "Business Leader / ãƒ“ã‚¸ãƒã‚¹ãƒªãƒ¼ãƒ€ãƒ¼": { en:"Business Leader", jp:"ãƒ“ã‚¸ãƒã‚¹ãƒªãƒ¼ãƒ€ãƒ¼", memo:"æ¸…æ½”æ„Ÿã‚ã‚‹äººç‰©ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆã€‚ã‚ªãƒ•ã‚£ã‚¹ç³»ã®ç´ æã¥ãã‚Šã«ã€‚" },
  "ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰": { en:"Fantasy Wizard", jp:"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰", memo:"é­”æ³•æ¼”å‡ºï¼‹å¹´é…é¡”ã€‚ä¸–ç•Œè¦³ã®å¼·ã„äººç‰©ã«å¯„ã›ã‚‹ã€‚" },
  "Fantasy Wizard / ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰": { en:"Fantasy Wizard", jp:"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰", memo:"é­”æ³•æ¼”å‡ºï¼‹å¹´é…é¡”ã€‚ä¸–ç•Œè¦³ã®å¼·ã„äººç‰©ã«å¯„ã›ã‚‹ã€‚" },
  "ã‚¹ãƒˆãƒªãƒ¼ãƒˆ ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ": { en:"Street Portrait", jp:"ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"è¡—ã‚¹ãƒŠãƒƒãƒ—é¢¨ã€‚è‡ªç„¶å…‰å¯„ã‚Šã§â€œä½œã‚Šè¾¼ã¿ã™ããªã„â€äººç‰©ã€‚" },
  "Street Portrait / ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ": { en:"Street Portrait", jp:"ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"è¡—ã‚¹ãƒŠãƒƒãƒ—é¢¨ã€‚è‡ªç„¶å…‰å¯„ã‚Šã§â€œä½œã‚Šè¾¼ã¿ã™ããªã„â€äººç‰©ã€‚" },
  "ãƒŠãƒãƒ¥ãƒ©ãƒ« ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼": { en:"Natural Beauty", jp:"ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼", memo:"æŸ”ã‚‰ã‹ã„å…‰ã§è‚Œã¨è¡¨æƒ…ã‚’ãã‚Œã„ã«ã€‚ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—å‘ã‘ã€‚" },
  "Natural Beauty / ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼": { en:"Natural Beauty", jp:"ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼", memo:"æŸ”ã‚‰ã‹ã„å…‰ã§è‚Œã¨è¡¨æƒ…ã‚’ãã‚Œã„ã«ã€‚ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—å‘ã‘ã€‚" },
  "å­ä¾›ã®ç¬‘é¡”": { en:"Child Smile", jp:"å­ä¾›ã®ç¬‘é¡”", memo:"æ˜ã‚‹ã„é›°å›²æ°—ã®å­ä¾›äººç‰©ã€‚å…¬åœ’ãƒ»æ—¥å¸¸ç³»ã«ã€‚" },
  "Child Smile / å­ä¾›ã®ç¬‘é¡”": { en:"Child Smile", jp:"å­ä¾›ã®ç¬‘é¡”", memo:"æ˜ã‚‹ã„é›°å›²æ°—ã®å­ä¾›äººç‰©ã€‚å…¬åœ’ãƒ»æ—¥å¸¸ç³»ã«ã€‚" },
  "ãƒ€ãƒ¼ã‚¯ãƒ’ãƒ¼ãƒ­ãƒ¼": { en:"Dark Hero", jp:"ãƒ€ãƒ¼ã‚¯ãƒ’ãƒ¼ãƒ­ãƒ¼", memo:"å½±ãƒ»é€†å…‰ã§ã‚·ãƒªã‚¢ã‚¹å¯„ã‚Šã€‚æ˜ ç”»é¢¨ã®äººç‰©ã«ã€‚" },
  "Dark Hero / ãƒ€ãƒ¼ã‚¯ãƒ’ãƒ¼ãƒ­ãƒ¼": { en:"Dark Hero", jp:"ãƒ€ãƒ¼ã‚¯ãƒ’ãƒ¼ãƒ­ãƒ¼", memo:"å½±ãƒ»é€†å…‰ã§ã‚·ãƒªã‚¢ã‚¹å¯„ã‚Šã€‚æ˜ ç”»é¢¨ã®äººç‰©ã«ã€‚" },
  "ã‚¨ãƒ«ãƒ•ã®æˆ¦å£«": { en:"Elf Warrior", jp:"ã‚¨ãƒ«ãƒ•ã®æˆ¦å£«", memo:"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼äººç‰©ã®å®šç•ªã€‚å¼“ã‚„è£…å‚™ãŒæ˜ ãˆã‚‹ã€‚" },
  "Elf Warrior / ã‚¨ãƒ«ãƒ•ã®æˆ¦å£«": { en:"Elf Warrior", jp:"ã‚¨ãƒ«ãƒ•ã®æˆ¦å£«", memo:"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼äººç‰©ã®å®šç•ªã€‚å¼“ã‚„è£…å‚™ãŒæ˜ ãˆã‚‹ã€‚" },
  "ã‚«ãƒ•ã‚§ã®å°‘å¥³": { en:"Cafe Girl", jp:"ã‚«ãƒ•ã‚§ã®å°‘å¥³", memo:"ã‚«ãƒ•ã‚§èƒŒæ™¯ï¼‹æŸ”ã‚‰ã‹ã„å…‰ã€‚SNSå‘ã‘äººç‰©ç´ æã«ã€‚" },
  "Cafe Girl / ã‚«ãƒ•ã‚§ã®å°‘å¥³": { en:"Cafe Girl", jp:"ã‚«ãƒ•ã‚§ã®å°‘å¥³", memo:"ã‚«ãƒ•ã‚§èƒŒæ™¯ï¼‹æŸ”ã‚‰ã‹ã„å…‰ã€‚SNSå‘ã‘äººç‰©ç´ æã«ã€‚" },
  "è€è³¢è€…": { en:"Ancient Sage", jp:"è€è³¢è€…", memo:"ã—ã‚ãƒ»å¹´é½¢è¡¨ç¾ã®ç¢ºèªç”¨ã€‚é¡”ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«é‡è¦–ã€‚" },
  "Ancient Sage / è€è³¢è€…": { en:"Ancient Sage", jp:"è€è³¢è€…", memo:"ã—ã‚ãƒ»å¹´é½¢è¡¨ç¾ã®ç¢ºèªç”¨ã€‚é¡”ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«é‡è¦–ã€‚" },
  "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ãƒ’ãƒ¼ãƒ­ãƒ¼": { en:"Action Hero", jp:"ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ’ãƒ¼ãƒ­ãƒ¼", memo:"å‹•ãã®ã‚ã‚‹äººç‰©ã‚’ä½œã‚‹ãƒ™ãƒ¼ã‚¹ã€‚ãƒãƒ¼ã‚ºæ¤œè¨¼ã«ã€‚" },
  "Action Hero / ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ’ãƒ¼ãƒ­ãƒ¼": { en:"Action Hero", jp:"ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ’ãƒ¼ãƒ­ãƒ¼", memo:"å‹•ãã®ã‚ã‚‹äººç‰©ã‚’ä½œã‚‹ãƒ™ãƒ¼ã‚¹ã€‚ãƒãƒ¼ã‚ºæ¤œè¨¼ã«ã€‚" },
  "é­”æ³•å°‘å¥³": { en:"Magical Girl", jp:"é­”æ³•å°‘å¥³", memo:"ç™ºå…‰è¡¨ç¾Ã—ã‚­ãƒ£ãƒ©æ„Ÿã®ç¢ºèªã€‚ãƒã‚ªãƒ³ç³»ã«å¼·ã„ã€‚" },
  "Magical Girl / é­”æ³•å°‘å¥³": { en:"Magical Girl", jp:"é­”æ³•å°‘å¥³", memo:"ç™ºå…‰è¡¨ç¾Ã—ã‚­ãƒ£ãƒ©æ„Ÿã®ç¢ºèªã€‚ãƒã‚ªãƒ³ç³»ã«å¼·ã„ã€‚" },
  "ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«": { en:"Professional Portrait", jp:"ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«", memo:"ãƒ“ã‚¸ãƒã‚¹ç”¨é€”ã®â€œã¡ã‚ƒã‚“ã¨ã—ãŸâ€äººç‰©ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸé¢¨ã€‚" },
  "Professional Portrait / ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«": { en:"Professional Portrait", jp:"ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«", memo:"ãƒ“ã‚¸ãƒã‚¹ç”¨é€”ã®â€œã¡ã‚ƒã‚“ã¨ã—ãŸâ€äººç‰©ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸé¢¨ã€‚" },
  "ã‚µãƒ ãƒ©ã‚¤": { en:"Samurai", jp:"ã‚µãƒ ãƒ©ã‚¤", memo:"å’Œé¢¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³äººç‰©ã€‚åˆ€ã‚„è¡£è£…ã®è¦‹ã›æ–¹ç¢ºèªã«ã€‚" },
  "Samurai / ã‚µãƒ ãƒ©ã‚¤": { en:"Samurai", jp:"ã‚µãƒ ãƒ©ã‚¤", memo:"å’Œé¢¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³äººç‰©ã€‚åˆ€ã‚„è¡£è£…ã®è¦‹ã›æ–¹ç¢ºèªã«ã€‚" },
  "å¤©ä½¿": { en:"Angel", jp:"å¤©ä½¿", memo:"ç™½ãƒ»å…‰ãƒ»ç¿¼ã®è¡¨ç¾ç¢ºèªã€‚ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼äººç‰©ã«ã€‚" },
  "Angel / å¤©ä½¿": { en:"Angel", jp:"å¤©ä½¿", memo:"ç™½ãƒ»å…‰ãƒ»ç¿¼ã®è¡¨ç¾ç¢ºèªã€‚ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼äººç‰©ã«ã€‚" },
  "ãƒ­ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼": { en:"Rock Star", jp:"ãƒ­ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼", memo:"ã‚¹ãƒ†ãƒ¼ã‚¸å…‰ã®æ¼”å‡ºç¢ºèªã€‚æ´¾æ‰‹ãªäººç‰©ã‚«ãƒƒãƒˆå‘ã‘ã€‚" },
  "Rock Star / ãƒ­ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼": { en:"Rock Star", jp:"ãƒ­ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼", memo:"ã‚¹ãƒ†ãƒ¼ã‚¸å…‰ã®æ¼”å‡ºç¢ºèªã€‚æ´¾æ‰‹ãªäººç‰©ã‚«ãƒƒãƒˆå‘ã‘ã€‚" },
  "ã‚¹ãƒ‘ã‚¤": { en:"Spy", jp:"ã‚¹ãƒ‘ã‚¤", memo:"ã‚¿ã‚¯ãƒ†ã‚£ã‚«ãƒ«è£…å‚™ï¼‹ç·Šå¼µæ„Ÿã€‚æ˜ ç”»ã‚¹ãƒãƒ«é¢¨ã«ã€‚" },
  "Spy / ã‚¹ãƒ‘ã‚¤": { en:"Spy", jp:"ã‚¹ãƒ‘ã‚¤", memo:"ã‚¿ã‚¯ãƒ†ã‚£ã‚«ãƒ«è£…å‚™ï¼‹ç·Šå¼µæ„Ÿã€‚æ˜ ç”»ã‚¹ãƒãƒ«é¢¨ã«ã€‚" },
  "ãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼": { en:"Dragon Rider", jp:"ãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼", memo:"é¨ä¹—ãƒ»é§ãƒ»é­”æ³•ã®äººç‰©å‘ã‘ã€‚è¿«åŠ›é‡è¦–ã®æ¤œè¨¼ç”¨ã€‚" },
  "Dragon Rider / ãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼": { en:"Dragon Rider", jp:"ãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼", memo:"é¨ä¹—ãƒ»é§ãƒ»é­”æ³•ã®äººç‰©å‘ã‘ã€‚è¿«åŠ›é‡è¦–ã®æ¤œè¨¼ç”¨ã€‚" },
  "ã‚«ãƒ•ã‚§ã‚ªãƒ¼ãƒŠãƒ¼": { en:"Cafe Owner", jp:"ã‚«ãƒ•ã‚§ã‚ªãƒ¼ãƒŠãƒ¼", memo:"æ—¥å¸¸äººç‰©ï¼ˆæ¥å®¢ï¼‰å‘ã‘ã€‚æ¸©ã‹ã„ç©ºæ°—æ„Ÿã®ç¢ºèªç”¨ã€‚" },
  "Cafe Owner / ã‚«ãƒ•ã‚§ã‚ªãƒ¼ãƒŠãƒ¼": { en:"Cafe Owner", jp:"ã‚«ãƒ•ã‚§ã‚ªãƒ¼ãƒŠãƒ¼", memo:"æ—¥å¸¸äººç‰©ï¼ˆæ¥å®¢ï¼‰å‘ã‘ã€‚æ¸©ã‹ã„ç©ºæ°—æ„Ÿã®ç¢ºèªç”¨ã€‚" },
  "Cinematic Portrait Soft": { en:"Cinematic Portrait", jp:"æ˜ ç”»é¢¨ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"æŸ”ã‚‰ã‹ã„æ˜ ç”»é¢¨ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆã€‚äººç‰©ã®è³ªæ„Ÿé‡è¦–ã€‚è‡ªç„¶å…‰ï¼‹æµ…ã„è¢«å†™ç•Œæ·±åº¦ã§ä½¿ã†åŸºæœ¬ãƒ—ãƒªã‚»ãƒƒãƒˆã€‚" },
  "Cinematic Portrait / æ˜ ç”»é¢¨ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ": { en:"Cinematic Portrait", jp:"æ˜ ç”»é¢¨ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"æŸ”ã‚‰ã‹ã„æ˜ ç”»é¢¨ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆã€‚äººç‰©ã®è³ªæ„Ÿé‡è¦–ã€‚è‡ªç„¶å…‰ï¼‹æµ…ã„è¢«å†™ç•Œæ·±åº¦ã§ä½¿ã†åŸºæœ¬ãƒ—ãƒªã‚»ãƒƒãƒˆã€‚" },
  "Cinematic Portrait Soft / æ˜ ç”»é¢¨ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ": { en:"Cinematic Portrait", jp:"æ˜ ç”»é¢¨ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ", memo:"æŸ”ã‚‰ã‹ã„æ˜ ç”»é¢¨ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆã€‚äººç‰©ã®è³ªæ„Ÿé‡è¦–ã€‚è‡ªç„¶å…‰ï¼‹æµ…ã„è¢«å†™ç•Œæ·±åº¦ã§ä½¿ã†åŸºæœ¬ãƒ—ãƒªã‚»ãƒƒãƒˆã€‚" },
  "Instagram Model": { en:"Instagram Model", jp:"SNSãƒ¢ãƒ‡ãƒ«", memo:"SNSãƒ»ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ç³»äººç‰©ã€‚æŠœã‘æ„Ÿã®ã‚ã‚‹ãƒãƒ¼ã‚ºã¨è‡ªç„¶ãªå…‰ã€‚" },
  "Instagram Model / SNSãƒ¢ãƒ‡ãƒ«": { en:"Instagram Model", jp:"SNSãƒ¢ãƒ‡ãƒ«", memo:"SNSãƒ»ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ç³»äººç‰©ã€‚æŠœã‘æ„Ÿã®ã‚ã‚‹ãƒãƒ¼ã‚ºã¨è‡ªç„¶ãªå…‰ã€‚" },
};

    function isCombinedName(name){
      return (name || '').includes(' / ');
    }

    function migrateOnePreset(p){
      if (!p || typeof p !== 'object') return p;

      const nameRaw = (p.name ?? '').toString().trim();
      if (!nameRaw) return p;

      // 1) name ã®çµ±ä¸€
      if (PRESET_NAME_MAP[nameRaw]) {
        const m = PRESET_NAME_MAP[nameRaw];
        p.name = `${m.en} / ${m.jp}`;
        // memo ã®è£œå®Œ
        if (!p.memo || !String(p.memo).trim()) p.memo = m.memo;
        return p;
      }

      // ã™ã§ã« "EN / JP" å½¢å¼ã®å ´åˆï¼šmemoã ã‘è£œå®Œ
      if (isCombinedName(nameRaw)) {
        if (PRESET_NAME_MAP[nameRaw] && (!p.memo || !String(p.memo).trim())) {
          p.memo = PRESET_NAME_MAP[nameRaw].memo;
        }
        return p;
      }

      // 2) ä¾‹å¤–ï¼šä¸€éƒ¨ã®è‹±èªåã®ã¿ â†’ memoè£œå®Œï¼ˆè©²å½“ãŒã‚ã‚Œã°ï¼‰
      // ï¼ˆå¿…è¦ãªã‚‰å¾Œã§è¿½åŠ ï¼‰
      return p;
    }

    function migratePresetsIfNeeded(presets){
      if (!Array.isArray(presets)) return presets;
      let changed = false;

      const migrated = presets.map(orig => {
        const p = { ...orig };
        const beforeName = (p.name ?? '').toString();
        const beforeMemo = (p.memo ?? '').toString();

        migrateOnePreset(p);

        const afterName = (p.name ?? '').toString();
        const afterMemo = (p.memo ?? '').toString();

        if (beforeName !== afterName || beforeMemo !== afterMemo) changed = true;
        return p;
      });

      return { presets: migrated, changed };
    }

// ===== RAWè¡¨è¨˜ =====
    function getRawMode() {
      const stored = localStorage.getItem(KEY_RAW_MODE);
      return stored === 'raw' ? 'raw' : 'style';
    }
    function setRawMode(mode){
      const m = (mode === 'raw') ? 'raw' : 'style';
      localStorage.setItem(KEY_RAW_MODE, m);
    }

    // ===== ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜/èª­è¾¼ =====
    function loadPresets() {
      const raw = localStorage.getItem(KEY_PRESETS);
      const parsed = safeParseJSON(raw, null);

      // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã€å¿…è¦ã«å¿œã˜ã¦ã€Œåå‰å½¢å¼ + memoã€ã‚’è‡ªå‹•è£œæ­£
      if (Array.isArray(parsed)) {
        const mig = migratePresetsIfNeeded(parsed);
        if (mig && mig.changed) {
          localStorage.setItem(KEY_PRESETS, JSON.stringify(mig.presets));
        }
        return mig ? mig.presets : parsed;
      }

      // åˆå›ã¯ç©ºé…åˆ—ã§é–‹å§‹
      localStorage.setItem(KEY_PRESETS, JSON.stringify(samplePresets));
      return [...samplePresets];
    }

    function savePresets(presets) {
      const safe = Array.isArray(presets) ? presets : [];
      localStorage.setItem(KEY_PRESETS, JSON.stringify(safe));
    }

    // ===== HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— =====
    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // ===== Customæ¬„ã®è¡¨ç¤º/éè¡¨ç¤º =====
    function syncCustomVisibility() {
      const pairs = [
        ['personTemplate', 'personTemplateCustomWrap'],
        ['composition', 'compositionCustomWrap'],
        ['angle', 'angleCustomWrap'],
        ['lighting', 'lightingCustomWrap'],
        ['background', 'backgroundCustomWrap'],
      ];
      pairs.forEach(([selectId, wrapId]) => {
        const sel = document.getElementById(selectId);
        const wrap = document.getElementById(wrapId);
        if (!sel || !wrap) return;
        wrap.style.display = (sel.value === 'custom') ? 'block' : 'none';
      });
    }

    // ===== äº’æ›é©ç”¨ï¼ˆselect or customï¼‰ =====
    function applyPresetField(selectId, customInputId, selectValue, customValue) {
      const sel = document.getElementById(selectId);
      const custom = document.getElementById(customInputId);
      if (!sel) return;

      const wantsCustom = (selectValue === 'custom') || (customValue && customValue.trim() !== '');
      const hasOption = (v) => Array.from(sel.options || []).some(o => o.value === v);

      if (wantsCustom) {
        sel.value = 'custom';
        if (custom) custom.value = (customValue || '').trim();
        return;
      }

      const v = (selectValue || '').trim();
      if (v && hasOption(v)) {
        sel.value = v;
        if (custom) custom.value = '';
      } else {
        sel.value = 'custom';
        if (custom) custom.value = v;
      }
    }

    // ===== ãƒªã‚»ãƒƒãƒˆ =====
    function resetPromptSettings({ keepRefs } = { keepRefs: true }) {
      const theme = document.getElementById('theme');
      if (theme) theme.value = '';

      const selects = ['personTemplate','composition','angle','lighting','background'];
      selects.forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        const first = sel.options && sel.options.length ? sel.options[0].value : '';
        sel.value = first;
      });

      const customs = ['personTemplateCustom','compositionCustom','angleCustom','lightingCustom','backgroundCustom'];
      customs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      const ar = document.getElementById('ar');
      const arCustom = document.getElementById('arCustom');
      if (ar) ar.value = '9:16';
      if (arCustom) arCustom.value = '';
      const wrap = document.getElementById('arCustomWrap');
      if (wrap) wrap.style.display = 'none';

      document.getElementById('stylize').value = 100;
      document.getElementById('chaos').value = 0;
      document.getElementById('quality').value = 1;
      document.getElementById('raw').checked = false;

      const fixedTail = document.getElementById('fixedTail'); if (fixedTail) fixedTail.value = '';
      const negative = document.getElementById('negative'); if (negative) negative.value = '';

      setRawMode('style');
      document.getElementById('rawStyle').checked = true;
      document.getElementById('rawRaw').checked = false;

      if (!keepRefs) {
        ['seed','sref','cref'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
      }

      syncCustomVisibility();
    }

    // ====== Custom AR ======
    function isValidAR(value) {
      return /^[0-9]+:[0-9]+$/.test((value || '').trim());
    }

    function setupARCustomToggle() {
      const arSelect = document.getElementById('ar');
      const wrap = document.getElementById('arCustomWrap');

      function sync() {
        const isCustom = arSelect.value === 'custom';
        wrap.style.display = isCustom ? 'block' : 'none';
      }

      arSelect.addEventListener('change', () => {
        sync();
        saveCurrentState();
        generatePrompt({ silentToast: true, overwriteEditor: true });
      });

      sync();
    }

    function setupCustomToggles() {
      const pairs = [
        ['personTemplate', 'personTemplateCustomWrap'],
        ['composition', 'compositionCustomWrap'],
        ['angle', 'angleCustomWrap'],
        ['lighting', 'lightingCustomWrap'],
        ['background', 'backgroundCustomWrap'],
      ];

      pairs.forEach(([selectId, wrapId]) => {
        const sel = document.getElementById(selectId);
        const wrap = document.getElementById(wrapId);
        if (!sel || !wrap) return;

        const sync = () => wrap.style.display = (sel.value === 'custom') ? 'block' : 'none';

        sel.addEventListener('change', () => {
          sync();
          saveCurrentState();
          generatePrompt({ silentToast: true, overwriteEditor: false });
        });

        sync();
      });
    }

    // ===== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆå·¦è¨­å®š â†’ æ–‡å­—åˆ—ï¼‰ =====
    function buildPromptString() {
      const theme = document.getElementById('theme').value.trim();

      const personTemplateSel = document.getElementById('personTemplate').value;
      const personTemplate = (personTemplateSel === 'custom')
        ? document.getElementById('personTemplateCustom').value.trim()
        : personTemplateSel;

      const compositionSel = document.getElementById('composition').value;
      const composition = (compositionSel === 'custom')
        ? document.getElementById('compositionCustom').value.trim()
        : compositionSel;

      const angleSel = document.getElementById('angle').value;
      const angle = (angleSel === 'custom')
        ? document.getElementById('angleCustom').value.trim()
        : angleSel;

      const lightingSel = document.getElementById('lighting').value;
      const lighting = (lightingSel === 'custom')
        ? document.getElementById('lightingCustom').value.trim()
        : lightingSel;

      const backgroundSel = document.getElementById('background').value;
      const background = (backgroundSel === 'custom')
        ? document.getElementById('backgroundCustom').value.trim()
        : backgroundSel;

      const fixedTail = (document.getElementById('fixedTail') ? document.getElementById('fixedTail').value.trim() : '');

      // â˜… è‡ªç”±å…¥åŠ›ï¼šãã®ã¾ã¾æœ«å°¾ã«è¿½è¨˜ï¼ˆè‡ªå‹•ã§ --no ã¯ä»˜ä¸ã—ãªã„ï¼‰
      const negative = (document.getElementById('negative') ? document.getElementById('negative').value.trim() : '');

      const promptParts = [];
      if (theme) promptParts.push(theme);
      if (personTemplate) promptParts.push(personTemplate);
      if (composition) promptParts.push(composition);
      if (angle) promptParts.push(angle);
      if (lighting) promptParts.push(lighting);
      if (background) promptParts.push(background);
      if (fixedTail) promptParts.push(fixedTail);

      const prompt = promptParts.join(', ');

      let ar = document.getElementById('ar').value;
      if (ar === 'custom') {
        const custom = document.getElementById('arCustom').value;
        ar = isValidAR(custom) ? custom.trim() : '';
      }

      const stylize = document.getElementById('stylize').value;
      const chaos = document.getElementById('chaos').value;
      const quality = document.getElementById('quality').value;
      const rawEnabled = document.getElementById('raw').checked;
      const seed = document.getElementById('seed').value;
      const sref = document.getElementById('sref').value.trim();
      const cref = document.getElementById('cref').value.trim();

      const params = [];
      if (ar) params.push(`--ar ${ar}`);
      if (stylize !== '' && stylize !== null && stylize !== undefined) params.push(`--stylize ${stylize}`);
      if (chaos && chaos != 0) params.push(`--chaos ${chaos}`);
      if (quality) params.push(`--quality ${quality}`);

      if (rawEnabled) {
        const mode = getRawMode();
        params.push(mode === 'raw' ? `--raw` : `--style raw`);
      }

      if (seed) params.push(`--seed ${seed}`);
      if (sref) params.push(`--sref ${sref}`);
      if (cref) params.push(`--cref ${cref}`);

      // â˜… ã“ã“ã§è‡ªç”±è¿½è¨˜ã‚’æœ€å¾Œã«å…¥ã‚Œã‚‹
      if (negative) params.push(negative);

      const fullPrompt = prompt + (params.length > 0 ? ' ' + params.join(' ') : '');
      return fullPrompt || 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    }

    
    // ===== ãƒ—ãƒªã‚»ãƒƒãƒˆç”¨ï¼šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—ã‚’ä½œã‚‹ï¼ˆæ¤œç´¢ç”¨ï¼‰ =====
    function buildPromptStringFromPreset(preset = {}) {
      const parts = [];

      const theme = (preset.theme || '').toString().trim();
      const personTemplate = (preset.personTemplateCustom || preset.personTemplate || '').toString().trim();
      const composition = (preset.compositionCustom || preset.composition || '').toString().trim();
      const angle = (preset.angleCustom || preset.angle || '').toString().trim();
      const lighting = (preset.lightingCustom || preset.lighting || '').toString().trim();
      const background = (preset.backgroundCustom || preset.background || '').toString().trim();

      if (theme) parts.push(theme);
      if (personTemplate) parts.push(personTemplate);
      if (composition) parts.push(composition);
      if (angle) parts.push(angle);
      if (lighting) parts.push(lighting);
      if (background) parts.push(background);

      const prompt = parts.join(', ');

      const params = [];
      if (preset.ar) params.push(`--ar ${preset.ar}`);
      if (preset.stylize !== '' && preset.stylize !== null && preset.stylize !== undefined) params.push(`--stylize ${preset.stylize}`);
      if (preset.chaos && preset.chaos != 0) params.push(`--chaos ${preset.chaos}`);
      if (preset.quality) params.push(`--quality ${preset.quality}`);
      if (preset.raw) params.push(`--raw`);
      if (preset.seed) params.push(`--seed ${preset.seed}`);
      if (preset.sref) params.push(`--sref ${preset.sref}`);
      if (preset.cref) params.push(`--cref ${preset.cref}`);
      if (preset.negative) params.push(preset.negative);

      return prompt + (params.length ? ' ' + params.join(' ') : '');
    }

function generatePrompt(opts = {}) {
      const { overwriteEditor = true, silentToast = false } = opts;

      const fullPrompt = buildPromptString();
      const editor = document.getElementById('outputEditor');

      if (overwriteEditor) {
        editor.value = fullPrompt;
        saveEditorText();
      } else {
        if (!editor.value || editor.value === 'ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...') {
          editor.value = fullPrompt;
          saveEditorText();
        }
      }

      saveCurrentState();
      if (!silentToast) { /* é€šçŸ¥ã—ãŸã‘ã‚Œã°ã“ã“ */ }
    }

    // ===== Copy: iPhone/Safariå¯¾ç­– =====
    async function copyToClipboard() {
      hideCopyHelper();

      const editor = document.getElementById('outputEditor');
      const text = (editor.value || '').trim();

      if (!text || text === 'ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...' ||
          text === 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚') {
        showToast('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      function selectEditorText() {
        try {
          editor.focus();
          editor.select();
          editor.setSelectionRange(0, editor.value.length);
          editor.scrollIntoView({ block: 'center', behavior: 'smooth' });
        } catch (_) {}
      }

      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
          return;
        }
      } catch (_) {}

      try {
        selectEditorText();
        const ok = document.execCommand('copy');
        if (ok) {
          showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
          return;
        }
      } catch (_) {}

      selectEditorText();
      showCopyHelper();
      showToast('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'error');
    }

    function showCopyHelper() {
      document.getElementById('copyHelper').style.display = 'block';
    }
    function hideCopyHelper() {
      document.getElementById('copyHelper').style.display = 'none';
    }

    // ===== Save / Update =====
    function saveOrUpdatePreset() {
      const name = (prompt('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆåŒåãŒã‚ã‚Œã°ä¸Šæ›¸ãæ›´æ–°ï¼‰:') || '').trim();
      if (!name) return;

      const presetsBefore = loadPresets();
      const existing = presetsBefore.find(p => p.name === name);
      const memo = (prompt('ãƒ¡ãƒ¢ï¼ˆç”¨é€”/ç‹™ã„ï¼‰â€»ä»»æ„:', (existing && existing.memo) ? existing.memo : '') || '').trim();

      let ar = document.getElementById('ar').value;
      let arCustom = '';
      if (ar === 'custom') {
        const custom = document.getElementById('arCustom').value;
        if (isValidAR(custom)) {
          arCustom = custom.trim();
          ar = 'custom';
        } else {
          ar = '9:16';
        }
      }

      const preset = {
        name,
        memo,
        theme: document.getElementById('theme').value,
        personTemplate: document.getElementById('personTemplate').value,
        composition: document.getElementById('composition').value,
        angle: document.getElementById('angle').value,
        lighting: document.getElementById('lighting').value,
        background: document.getElementById('background').value,
        personTemplateCustom: document.getElementById('personTemplateCustom') ? document.getElementById('personTemplateCustom').value : '',
        compositionCustom: document.getElementById('compositionCustom') ? document.getElementById('compositionCustom').value : '',
        angleCustom: document.getElementById('angleCustom') ? document.getElementById('angleCustom').value : '',
        lightingCustom: document.getElementById('lightingCustom') ? document.getElementById('lightingCustom').value : '',
        backgroundCustom: document.getElementById('backgroundCustom') ? document.getElementById('backgroundCustom').value : '',
        ar,
        arCustom,
        stylize: parseInt(document.getElementById('stylize').value, 10),
        chaos: parseInt(document.getElementById('chaos').value, 10),
        quality: parseFloat(document.getElementById('quality').value),
        raw: document.getElementById('raw').checked,
        rawMode: getRawMode(),
        fixedTail: document.getElementById('fixedTail') ? document.getElementById('fixedTail').value : '',
        negative: document.getElementById('negative') ? document.getElementById('negative').value : '',
        seed: document.getElementById('seed').value,
        sref: document.getElementById('sref').value,
        cref: document.getElementById('cref').value
      };

      const presets = loadPresets();
      const idx = presets.findIndex(p => (p?.name || '').trim() === name);

      if (idx >= 0) {
        presets[idx] = preset;
        const updated = presets.splice(idx, 1)[0];
        presets.unshift(updated);
        savePresets(presets);
        displayPresets();
        showToast(`"${name}" ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
      } else {
        presets.unshift(preset);
        savePresets(presets);
        displayPresets();
        showToast(`"${name}" ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
      }
    }

    // ===== ãƒˆãƒ¼ã‚¹ãƒˆ =====
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.classList.remove('error');
      if (type === 'error') toast.classList.add('error');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }

    // ===== Clear =====
    function clearAll() {
      resetPromptSettings({ keepRefs: false });

      const editor = document.getElementById('outputEditor');
      editor.value = 'ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...';
      saveEditorText();

      localStorage.removeItem(KEY_LAST_STATE);
      showToast('åˆæœŸåŒ–ã—ã¾ã—ãŸ');
    }

    // ===== ãƒ—ãƒªã‚»ãƒƒãƒˆè¡¨ç¤º =====
    function displayPresets() {
      const list = document.getElementById('presetList');
      const presets = loadPresets();

      // æ¤œç´¢ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆåãƒ»ãƒ¡ãƒ¢ãƒ»ãƒ†ãƒ¼ãƒãƒ»ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
      const q = (document.getElementById('presetSearch')?.value || '').trim().toLowerCase();

      if (!presets.length) {
        list.innerHTML = '<div class="small-text">ãƒ—ãƒªã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå…ƒã®indexã¯ä¿æŒã™ã‚‹ï¼‰
      const filtered = presets.map((p, idx) => ({ p, idx })).filter(({ p }) => {
        if (!q) return true;
        const name = (p.name || '').toLowerCase();
        const memo = (p.memo || '').toLowerCase();
        const theme = (p.theme || '').toLowerCase();
        const prompt = buildPromptStringFromPreset(p).toLowerCase();
        return (name + ' ' + memo + ' ' + theme + ' ' + prompt).includes(q);
      });

      if (!filtered.length) {
        list.innerHTML = '<div class="small-text">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      list.innerHTML = filtered.map(({ p, idx }) => {
        const title = escapeHtml(p.name || '(no name)');
        const memo  = escapeHtml(p.memo || '');
        const snippet = escapeHtml((p.theme || '').slice(0, 60));
        return `
          <div class="preset-item" data-index="${idx}">
            <div class="preset-item-row">
              <div class="preset-main">
                <h4>${title}</h4>
                <p>${snippet}</p>
                ${memo ? `<div class="preset-memo">${memo}</div>` : ``}
              </div>
              <div class="preset-actions">
                <button class="preset-btn danger" type="button" data-action="delete" data-index="${idx}" title="å‰Šé™¤">ğŸ—‘</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ =====
    function loadPreset(index) {
      const presets = loadPresets();
      const preset = presets[index];
      if (!preset) return;

      resetPromptSettings({ keepRefs: true });

      const keepSeed = document.getElementById('seed').value;
      const keepSref = document.getElementById('sref').value;
      const keepCref = document.getElementById('cref').value;

      document.getElementById('theme').value = preset.theme || '';

      applyPresetField('personTemplate', 'personTemplateCustom', preset.personTemplate, preset.personTemplateCustom);
      applyPresetField('composition', 'compositionCustom', preset.composition, preset.compositionCustom);
      applyPresetField('angle', 'angleCustom', preset.angle, preset.angleCustom);
      applyPresetField('lighting', 'lightingCustom', preset.lighting, preset.lightingCustom);
      applyPresetField('background', 'backgroundCustom', preset.background, preset.backgroundCustom);

      if (preset.ar && preset.ar !== 'custom') {
        document.getElementById('ar').value = preset.ar;
        document.getElementById('arCustom').value = '';
      } else {
        document.getElementById('ar').value = '9:16';
        document.getElementById('arCustom').value = '';
      }
      if (preset.ar === 'custom' && preset.arCustom && isValidAR(preset.arCustom)) {
        document.getElementById('ar').value = 'custom';
        document.getElementById('arCustom').value = preset.arCustom;
      }
      document.getElementById('arCustomWrap').style.display =
        (document.getElementById('ar').value === 'custom') ? 'block' : 'none';

      document.getElementById('stylize').value = preset.stylize ?? 100;
      document.getElementById('chaos').value = preset.chaos ?? 0;
      document.getElementById('quality').value = preset.quality ?? 1;
      document.getElementById('raw').checked = preset.raw || false;

      if (document.getElementById('fixedTail')) document.getElementById('fixedTail').value = preset.fixedTail || '';
      if (document.getElementById('negative')) document.getElementById('negative').value = preset.negative || '';

      if (preset.rawMode) setRawMode(preset.rawMode);
      const mode = getRawMode();
      document.getElementById('rawStyle').checked = (mode === 'style');
      document.getElementById('rawRaw').checked = (mode === 'raw');

      document.getElementById('seed').value = (preset.seed !== undefined && preset.seed !== null && preset.seed !== '') ? preset.seed : keepSeed;
      document.getElementById('sref').value = (preset.sref !== undefined && preset.sref !== null && preset.sref !== '') ? preset.sref : keepSref;
      document.getElementById('cref').value = (preset.cref !== undefined && preset.cref !== null && preset.cref !== '') ? preset.cref : keepCref;

      syncCustomVisibility();
      generatePrompt({ overwriteEditor: true, silentToast: true });
      saveCurrentState();
      showToast(`"${preset.name}" ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    }

    // ===== JSON Export / Import =====
    function openJsonModal(mode) {
      const backdrop = document.getElementById('jsonBackdrop');
      const textarea = document.getElementById('jsonTextarea');
      const title = document.getElementById('jsonModalTitle');
      const btnCopy = document.getElementById('btnJsonCopy');
      const btnApply = document.getElementById('btnJsonApply');

      backdrop.style.display = 'flex';
      backdrop.setAttribute('aria-hidden', 'false');
      backdrop.dataset.mode = mode;

      if (mode === 'export') {
        title.textContent = 'Preset JSON Export';
        textarea.value = JSON.stringify(loadPresets(), null, 2);
        textarea.readOnly = true;
        btnCopy.style.display = 'inline-block';
        btnApply.style.display = 'none';
      } else {
        title.textContent = 'Preset JSON Import';
        textarea.value = '';
        textarea.readOnly = false;
        btnCopy.style.display = 'none';
        btnApply.style.display = 'inline-block';
      }
    }

    function closeJsonModal() {
      const backdrop = document.getElementById('jsonBackdrop');
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden', 'true');
      backdrop.dataset.mode = '';
    }

    function copyJsonFromModal() {
      const textarea = document.getElementById('jsonTextarea');
      textarea.select();
      textarea.setSelectionRange(0, textarea.value.length);
      try {
        document.execCommand('copy');
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      } catch (e) {
        showToast('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆæ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰', 'error');
      }
      window.getSelection && window.getSelection().removeAllRanges();
    }

    function applyJsonImport() {
      const textarea = document.getElementById('jsonTextarea');
      let imported;
      try {
        imported = JSON.parse(textarea.value);
      } catch (e) {
        showToast('JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      const arr = Array.isArray(imported) ? imported : (Array.isArray(imported?.presets) ? imported.presets : null);
      if (!arr) {
        showToast('JSONã¯é…åˆ—ï¼ˆ[]ï¼‰ã¾ãŸã¯ { presets: [] } ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'error');
        return;
      }

      const cleaned = [];
      for (const p of arr) {
        if (!p || typeof p !== 'object') continue;
        const name = (p.name || '').toString().trim();
        if (!name) continue;

        cleaned.push({
          name,
          memo: (p.memo || '').toString(),
          theme: (p.theme || '').toString(),

          personTemplate: (p.personTemplate ?? p.person ?? '').toString(),
          personTemplateCustom: (p.personTemplateCustom ?? p.personCustom ?? '').toString(),

          composition: (p.composition || '').toString(),
          compositionCustom: (p.compositionCustom || '').toString(),

          angle: (p.angle || '').toString(),
          angleCustom: (p.angleCustom || '').toString(),

          lighting: (p.lighting || '').toString(),
          lightingCustom: (p.lightingCustom || '').toString(),

          background: (p.background || '').toString(),
          backgroundCustom: (p.backgroundCustom || '').toString(),

          ar: (p.ar || '9:16').toString(),
          arCustom: (p.arCustom || '').toString(),

          stylize: Number.isFinite(+p.stylize) ? +p.stylize : 100,
          chaos: Number.isFinite(+p.chaos) ? +p.chaos : 0,
          quality: Number.isFinite(+p.quality) ? +p.quality : 1,

          raw: !!p.raw,
          rawMode: (p.rawMode || getRawMode()).toString() === 'raw' ? 'raw' : 'style',

          fixedTail: (p.fixedTail || '').toString(),
          negative: (p.negative || '').toString(),
          seed: (p.seed || '').toString(),
          sref: (p.sref || '').toString(),
          cref: (p.cref || '').toString(),
        });
      }

      if (cleaned.length === 0) {
        showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
        return;
      }

      const existing = loadPresets();
      const map = new Map(existing.map(p => [p.name, p]));
      for (const p of cleaned) map.set(p.name, p);
      const merged = Array.from(map.values());

      savePresets(merged);
      displayPresets();
      closeJsonModal();
      showToast(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ˆ${cleaned.length}ä»¶ï¼‰`);
    }

    // ===== JSON File Export / Import =====
    function exportPresetsToFile() {
      const data = JSON.stringify(loadPresets(), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      const ts = new Date();
      const pad = (n) => String(n).padStart(2,'0');
      const filename = `mj-presets_${ts.getFullYear()}-${pad(ts.getMonth()+1)}-${pad(ts.getDate())}.json`;
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 250);
      showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
    }

    function importPresetsFromText(jsonText) {
      let imported;
      try {
        imported = JSON.parse(jsonText);
      } catch (e) {
        showToast('JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      const arr = Array.isArray(imported) ? imported : (Array.isArray(imported?.presets) ? imported.presets : null);
      if (!arr) {
        showToast('JSONã¯é…åˆ—ï¼ˆ[]ï¼‰ã¾ãŸã¯ { presets: [] } ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'error');
        return;
      }

      const cleaned = [];
      for (const p of arr) {
        if (!p || typeof p !== 'object') continue;
        const name = (p.name || '').toString().trim();
        if (!name) continue;

        cleaned.push({
          name,
          memo: (p.memo || '').toString(),
          theme: (p.theme || '').toString(),

          personTemplate: (p.personTemplate ?? p.person ?? '').toString(),
          personTemplateCustom: (p.personTemplateCustom ?? p.personCustom ?? '').toString(),

          composition: (p.composition || '').toString(),
          compositionCustom: (p.compositionCustom || '').toString(),

          angle: (p.angle || '').toString(),
          angleCustom: (p.angleCustom || '').toString(),

          lighting: (p.lighting || '').toString(),
          lightingCustom: (p.lightingCustom || '').toString(),

          background: (p.background || '').toString(),
          backgroundCustom: (p.backgroundCustom || '').toString(),

          ar: (p.ar || '9:16').toString(),
          arCustom: (p.arCustom || '').toString(),

          stylize: Number.isFinite(+p.stylize) ? +p.stylize : 100,
          chaos: Number.isFinite(+p.chaos) ? +p.chaos : 0,
          quality: Number.isFinite(+p.quality) ? +p.quality : 1,

          raw: !!p.raw,
          rawMode: (p.rawMode || getRawMode()).toString() === 'raw' ? 'raw' : 'style',

          fixedTail: (p.fixedTail || '').toString(),
          negative: (p.negative || '').toString(),
          seed: (p.seed || '').toString(),
          sref: (p.sref || '').toString(),
          cref: (p.cref || '').toString(),
        });
      }

      if (cleaned.length === 0) {
        showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
        return;
      }

      const existing = loadPresets();
      const map = new Map(existing.map(p => [p.name, p]));
      for (const p of cleaned) map.set(p.name, p);
      const merged = Array.from(map.values());

      savePresets(merged);
      displayPresets();
      showToast(`ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ˆ${cleaned.length}ä»¶ï¼‰`);
    }

    function importPresetsFromFile(file) {
      const reader = new FileReader();
      reader.onload = () => importPresetsFromText(String(reader.result || ''));
      reader.onerror = () => showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ', 'error');
      reader.readAsText(file);
    }

    // ===== ã‚¨ãƒ‡ã‚£ã‚¿ä¿å­˜/å¾©å…ƒ =====
    function saveEditorText() {
      const editor = document.getElementById('outputEditor');
      localStorage.setItem(KEY_EDITOR, editor.value || '');
    }

    function restoreEditorText() {
      const stored = localStorage.getItem(KEY_EDITOR);
      if (!stored) return;
      const editor = document.getElementById('outputEditor');
      if (!editor.value || editor.value === 'ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...') {
        editor.value = stored;
      }
    }

    // ===== çŠ¶æ…‹ ä¿å­˜/å¾©å…ƒ =====
    function saveCurrentState() {
      const arVal = document.getElementById('ar').value;
      const currentState = {
        theme: document.getElementById('theme').value,
        personTemplate: document.getElementById('personTemplate').value,
        personTemplateCustom: document.getElementById('personTemplateCustom') ? document.getElementById('personTemplateCustom').value : '',
        composition: document.getElementById('composition').value,
        compositionCustom: document.getElementById('compositionCustom') ? document.getElementById('compositionCustom').value : '',
        angle: document.getElementById('angle').value,
        angleCustom: document.getElementById('angleCustom') ? document.getElementById('angleCustom').value : '',
        lighting: document.getElementById('lighting').value,
        lightingCustom: document.getElementById('lightingCustom') ? document.getElementById('lightingCustom').value : '',
        background: document.getElementById('background').value,
        backgroundCustom: document.getElementById('backgroundCustom') ? document.getElementById('backgroundCustom').value : '',
        ar: arVal,
        arCustom: document.getElementById('arCustom') ? document.getElementById('arCustom').value : '',
        stylize: document.getElementById('stylize').value,
        chaos: document.getElementById('chaos').value,
        quality: document.getElementById('quality').value,
        raw: document.getElementById('raw').checked,
        rawMode: getRawMode(),
        seed: document.getElementById('seed').value,
        sref: document.getElementById('sref').value,
        cref: document.getElementById('cref').value,
        fixedTail: document.getElementById('fixedTail') ? document.getElementById('fixedTail').value : '',
        negative: document.getElementById('negative') ? document.getElementById('negative').value : '',
      };
      localStorage.setItem(KEY_LAST_STATE, JSON.stringify(currentState));
    }

    function restoreLastState() {
      const stored = localStorage.getItem(KEY_LAST_STATE);
      if (!stored) return;

      const state = safeParseJSON(stored, null);
      if (!state) return;

      document.getElementById('theme').value = state.theme || '';
      document.getElementById('personTemplate').value = state.personTemplate || '';
      document.getElementById('composition').value = state.composition || 'close-up shot';
      document.getElementById('angle').value = state.angle || 'front view';
      document.getElementById('lighting').value = state.lighting || 'soft window light';
      document.getElementById('background').value = state.background || 'city night background';
      document.getElementById('ar').value = state.ar || '9:16';

      document.getElementById('personTemplateCustom').value = state.personTemplateCustom || '';
      document.getElementById('compositionCustom').value = state.compositionCustom || '';
      document.getElementById('angleCustom').value = state.angleCustom || '';
      document.getElementById('lightingCustom').value = state.lightingCustom || '';
      document.getElementById('backgroundCustom').value = state.backgroundCustom || '';

      document.getElementById('arCustom').value = state.arCustom || '';
      document.getElementById('arCustomWrap').style.display =
        (document.getElementById('ar').value === 'custom') ? 'block' : 'none';

      document.getElementById('stylize').value = state.stylize ?? 100;
      document.getElementById('chaos').value = state.chaos ?? 0;
      document.getElementById('quality').value = state.quality ?? 1;
      document.getElementById('raw').checked = state.raw || false;

      if (document.getElementById('fixedTail')) document.getElementById('fixedTail').value = state.fixedTail || '';
      if (document.getElementById('negative')) document.getElementById('negative').value = state.negative || '';

      document.getElementById('seed').value = state.seed || '';
      document.getElementById('sref').value = state.sref || '';
      document.getElementById('cref').value = state.cref || '';

      if (state.rawMode) setRawMode(state.rawMode);
      const mode = getRawMode();
      document.getElementById('rawStyle').checked = (mode === 'style');
      document.getElementById('rawRaw').checked = (mode === 'raw');

      syncCustomVisibility();
    }

    // ===== è‡ªå‹•ä¿å­˜ =====
    function setupAutoSave() {
      const fields = [
        'theme', 'personTemplate', 'personTemplateCustom', 'composition', 'compositionCustom', 'angle', 'angleCustom',
        'lighting', 'lightingCustom', 'background', 'backgroundCustom', 'ar', 'arCustom', 'stylize',
        'chaos', 'quality', 'raw', 'fixedTail', 'negative', 'seed', 'sref', 'cref'
      ];

      fields.forEach((fieldId) => {
        const el = document.getElementById(fieldId);
        if (!el) return;

        el.addEventListener('input', () => saveCurrentState());

        el.addEventListener('change', () => {
          saveCurrentState();
          generatePrompt({ silentToast: true, overwriteEditor: true });
        });
      });
    }

    // ===== ãƒœã‚¿ãƒ³ =====
    function setupButtons() {
      document.getElementById('btnGenerate').addEventListener('click', () => generatePrompt({ overwriteEditor:true }));
      document.getElementById('btnSave').addEventListener('click', saveOrUpdatePreset);
      document.getElementById('btnCopy').addEventListener('click', copyToClipboard);
      document.getElementById('btnRebuild').addEventListener('click', () => generatePrompt({ overwriteEditor:true }));
      document.getElementById('btnClear').addEventListener('click', clearAll);

      // Preset Import / Export
      const _btnExportJson = document.getElementById('btnExportJson');
      if (_btnExportJson) _btnExportJson.addEventListener('click', () => openJsonModal('export'));
      const _btnImportJson = document.getElementById('btnImportJson');
      if (_btnImportJson) _btnImportJson.addEventListener('click', () => openJsonModal('import'));
      document.getElementById('btnExportFile').addEventListener('click', exportPresetsToFile);
      document.getElementById('btnImportFile').addEventListener('click', () => {
        const input = document.getElementById('presetFileInput');
        input.value = '';
        input.click();
      });
      document.getElementById('presetFileInput').addEventListener('change', (e) => {
        const file = e.target && e.target.files ? e.target.files[0] : null;
        if (!file) return;
        importPresetsFromFile(file);
      });

      // ãƒ—ãƒªã‚»ãƒƒãƒˆæ¤œç´¢ï¼ˆåå‰ï¼‹ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
      const presetSearch = document.getElementById('presetSearch');
      const btnPresetSearchClear = document.getElementById('btnPresetSearchClear');
      if (presetSearch) {
        presetSearch.addEventListener('input', () => {
          displayPresets();
        });
      }
      if (btnPresetSearchClear) {
        btnPresetSearchClear.addEventListener('click', () => {
          if (!presetSearch) return;
          presetSearch.value = '';
          presetSearch.focus();
          displayPresets();
        });
      }

      document.getElementById('btnJsonClose').addEventListener('click', closeJsonModal);
      document.getElementById('btnJsonCopy').addEventListener('click', copyJsonFromModal);
      document.getElementById('btnJsonApply').addEventListener('click', applyJsonImport);
      document.getElementById('jsonBackdrop').addEventListener('click', (e) => {
        if (e.target && e.target.id === 'jsonBackdrop') closeJsonModal();
      });

      // RAWè¡¨è¨˜ã®åˆ‡æ›¿
      document.getElementById('rawStyle').addEventListener('change', () => {
        if (document.getElementById('rawStyle').checked) setRawMode('style');
        saveCurrentState();
        generatePrompt({ silentToast:true, overwriteEditor:true });
      });
      document.getElementById('rawRaw').addEventListener('change', () => {
        if (document.getElementById('rawRaw').checked) setRawMode('raw');
        saveCurrentState();
        generatePrompt({ silentToast:true, overwriteEditor:true });
      });

      // ã‚³ãƒ”ãƒ¼ãƒ˜ãƒ«ãƒ‘ãƒ¼é–‰ã˜ã‚‹
      document.getElementById('btnCopyHelpClose').addEventListener('click', hideCopyHelper);

      // ãƒ—ãƒªã‚»ãƒƒãƒˆï¼šèª­ã¿è¾¼ã¿ & å‰Šé™¤ï¼ˆå§”è­²ï¼‰
      document.getElementById('presetList').addEventListener('click', (e) => {
        const delBtn = e.target.closest('button[data-action="delete"]');
        if (delBtn) {
          const idx = Number(delBtn.dataset.index);
          const presets = loadPresets();
          const target = presets[idx];
          if (!target) return;
          if (!confirm(`ã€Œ${target.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
          presets.splice(idx, 1);
          savePresets(presets);
          displayPresets();
          return;
        }

        const item = e.target.closest('.preset-item');
        if (!item) return;
        const idx = Number(item.dataset.index);
        if (!Number.isFinite(idx)) return;
        loadPreset(idx);
      });
    }

    // ===== åˆæœŸåŒ– =====
    window.addEventListener('DOMContentLoaded', () => {
      loadPresets();

      setupButtons();
      setupARCustomToggle();
      setupCustomToggles();
      setupAutoSave();

      restoreLastState();
      restoreEditorText();

      displayPresets();

      // èµ·å‹•æ™‚ã«ä¸€å›ç”Ÿæˆï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã¯ä¸Šæ›¸ãã—ãªã„ï¼‰
      generatePrompt({ silentToast: true, overwriteEditor: false });
    });
  </script>
</body>
</html>
