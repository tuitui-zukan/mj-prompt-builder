<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Midjourney Prompt Builder</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* âœ… æ¨ªã«ã¯ã¿å‡ºã—ç¦æ­¢ï¼ˆæœ€é‡è¦ï¼‰ */
    html, body { overflow-x: hidden; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 { font-size: 2rem; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 0.95rem; }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }

    .section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      min-width: 0; /* âœ… iOS/Safariã®æ¨ªã¯ã¿å‡ºã—å¯¾ç­– */
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.3rem;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group { margin-bottom: 20px; }

    label {
      display: block;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      max-width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s;
      overflow-x: hidden; /* âœ… æ–‡å­—ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ */
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-group { display: flex; align-items: center; gap: 10px; }

    input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

    .button-group { display: flex; gap: 10px; margin-top: 25px; }

    button {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      max-width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }

    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }

    /* âœ… å‡ºåŠ›æ¬„ï¼šæ¨ªã«ä¼¸ã³ãªã„ï¼‹é•·ããªã£ãŸã‚‰ä¸­ã ã‘ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    .output-box {
      background: white;
      border: 2px solid #667eea;
      border-radius: 12px;
      padding: 20px;
      min-height: 150px;
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
      line-height: 1.6;
      color: #333;
      max-width: 100%;
      max-height: 220px;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .preset-list {
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      -webkit-overflow-scrolling: touch;
    }

    .preset-item {
      padding: 12px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid #667eea;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation; /* âœ… iPhoneã§ã‚¿ãƒƒãƒ—åå¿œæ”¹å–„ */
    }
    .preset-item:hover { background: #e9ecef; transform: translateX(5px); }

    .preset-item h4 { color: #667eea; margin-bottom: 5px; font-size: 0.9rem; }
    .preset-item p { color: #666; font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .param-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.5rem; }
      .param-grid { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      body { padding: 10px; }
      .main-content { padding: 15px; gap: 15px; }
      .section { padding: 15px; }
    }

    .small-text { font-size: 0.8rem; color: #888; margin-top: 5px; }

    /* âœ… URLå…¥åŠ›æ¬„ï¼šæ¨ªã«ä¼¸ã³ãªã„ï¼‹é•·ããªã£ãŸã‚‰ä¸­ã ã‘ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    .url-box{
      width: 100%;
      min-height: 44px;
      max-height: 140px;
      resize: vertical;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¨ Midjourney Prompt Builder</h1>
      <p>ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªMidjourneyãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç°¡å˜ã«ä½œæˆ</p>
    </div>

    <div class="main-content">
      <!-- å·¦å´ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="section">
        <h2>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</h2>

        <div class="form-group">
          <label for="theme">ãƒ†ãƒ¼ãƒ / Theme</label>
          <input type="text" id="theme" placeholder="ä¾‹: a cyberpunk warrior in neon city" />
        </div>

        <div class="form-group">
          <label for="personTemplate">äººç‰©ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ / Person Template</label>
          <select id="personTemplate">
            <option value="">ãªã— / None</option>
            <option value="beautiful young woman, detailed face, expressive eyes">Beautiful Young Woman</option>
            <option value="handsome man, sharp jawline, confident expression">Handsome Man</option>
            <option value="elderly person, wise expression, wrinkled face">Elderly Person</option>
            <option value="child, innocent eyes, playful expression">Child</option>
            <option value="fantasy character, unique features, mystical appearance">Fantasy Character</option>
          </select>
        </div>

        <div class="param-grid">
          <div class="form-group">
            <label for="composition">æ§‹å›³ / Composition</label>
            <select id="composition">
              <option value="close-up shot">Close-up</option>
              <option value="portrait shot">Portrait</option>
              <option value="mid-body shot">Mid-body</option>
              <option value="full-body shot">Full-body</option>
            </select>
          </div>

          <div class="form-group">
            <label for="angle">ã‚¢ãƒ³ã‚°ãƒ« / Angle</label>
            <select id="angle">
              <option value="front view">Front</option>
              <option value="three-quarter view">Three-quarter</option>
              <option value="side view">Side</option>
              <option value="over-shoulder view">Over-shoulder</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="lighting">ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚° / Lighting</label>
          <select id="lighting">
            <option value="soft window light">Soft Window Light</option>
            <option value="neon rim lighting">Neon Rim Lighting</option>
            <option value="cinematic key light">Cinematic Key Light</option>
            <option value="studio beauty lighting">Studio Beauty Lighting</option>
          </select>
        </div>

        <div class="form-group">
          <label for="background">èƒŒæ™¯ / Background</label>
          <select id="background">
            <option value="city night background">City Night</option>
            <option value="minimal studio background">Minimal Studio</option>
            <option value="cafe street background">Cafe Street</option>
          </select>
        </div>

        <h2 style="margin-top: 30px;">âš™ï¸ Midjourneyãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h2>

        <div class="param-grid">
          <div class="form-group">
            <label for="ar">ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” / --ar</label>
            <select id="ar">
              <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
              <option value="16:9">16:9 (æ¨ªé•·)</option>
              <option value="9:16">9:16 (ç¸¦é•·)</option>
              <option value="4:3">4:3</option>
              <option value="3:2">3:2</option>
              <option value="2:3">2:3</option>
            </select>
          </div>

          <div class="form-group">
            <label for="stylize">ã‚¹ã‚¿ã‚¤ãƒ©ã‚¤ã‚º / --stylize</label>
            <input type="number" id="stylize" min="0" max="1000" value="100" step="50" />
            <div class="small-text">0-1000 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100)</div>
          </div>

          <div class="form-group">
            <label for="chaos">ã‚«ã‚ªã‚¹ / --chaos</label>
            <input type="number" id="chaos" min="0" max="100" value="0" step="10" />
            <div class="small-text">0-100 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0)</div>
          </div>

          <div class="form-group">
            <label for="quality">å“è³ª / --quality</label>
            <select id="quality">
              <option value="0.25">0.25 (ä½é€Ÿ)</option>
              <option value="0.5">0.5</option>
              <option value="1" selected>1 (æ¨™æº–)</option>
              <option value="2">2 (é«˜å“è³ª)</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="raw" />
            <label for="raw" style="margin-bottom: 0;">RAWãƒ¢ãƒ¼ãƒ‰ / --style raw</label>
          </div>
          <div class="small-text">ã‚ˆã‚Šãƒªã‚¢ãƒ«ã§å†™çœŸçš„ãªçµæœ</div>
        </div>

        <div class="form-group">
          <label for="seed">ã‚·ãƒ¼ãƒ‰ / --seed (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
          <input type="number" id="seed" placeholder="ä¾‹: 12345" />
          <div class="small-text">åŒã˜ã‚·ãƒ¼ãƒ‰ã§ä¸€è²«ã—ãŸçµæœ</div>
        </div>

        <!-- âœ… inputâ†’textarea ã«å¤‰æ›´ï¼ˆé•·ã„URLã§æ¨ªã«ä¼¸ã³ãªã„ï¼‰ -->
        <div class="form-group">
          <label for="sref">ã‚¹ã‚¿ã‚¤ãƒ«å‚ç…§ / --sref (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
          <textarea id="sref" class="url-box" placeholder="ç”»åƒURL"></textarea>
          <div class="small-text">ã‚¹ã‚¿ã‚¤ãƒ«å‚ç…§ç”»åƒã®URLï¼ˆé•·ããªã£ãŸã‚‰ã“ã®æ¬„ã®ä¸­ã ã‘ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰</div>
        </div>

        <div class="form-group">
          <label for="cref">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‚ç…§ / --cref (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
          <textarea id="cref" class="url-box" placeholder="ç”»åƒURL"></textarea>
          <div class="small-text">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‚ç…§ç”»åƒã®URLï¼ˆé•·ããªã£ãŸã‚‰ã“ã®æ¬„ã®ä¸­ã ã‘ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰</div>
        </div>

        <div class="button-group">
          <button class="btn-primary" onclick="generatePrompt()">âœ¨ Generate</button>
          <button class="btn-success" onclick="savePreset()">ğŸ’¾ Save</button>
        </div>
      </div>

      <!-- å³å´ï¼šå‡ºåŠ›ã¨ãƒ—ãƒªã‚»ãƒƒãƒˆ -->
      <div class="section">
        <h2>ğŸ¯ ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h2>
        <div class="output-box" id="output">ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</div>
        <div class="button-group">
          <button class="btn-secondary" onclick="copyToClipboard()">ğŸ“‹ Copy to Clipboard</button>
        </div>

        <h2 style="margin-top: 30px;">ğŸ“š ãƒ—ãƒªã‚»ãƒƒãƒˆ</h2>
        <div class="preset-list" id="presetList"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

  <script>
    // ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆ20å€‹ï¼‰
    const samplePresets = [
      {
        name: "ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ",
        theme: "cyberpunk warrior with glowing tattoos",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "portrait shot",
        angle: "three-quarter view",
        lighting: "neon rim lighting",
        background: "city night background",
        ar: "9:16",
        stylize: 150,
        chaos: 20,
        quality: 1,
        raw: true
      },
      {
        name: "ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆ ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³",
        theme: "elegant fashion model in luxury dress",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "full-body shot",
        angle: "front view",
        lighting: "studio beauty lighting",
        background: "minimal studio background",
        ar: "2:3",
        stylize: 200,
        chaos: 0,
        quality: 2,
        raw: false
      },
      {
        name: "ãƒ“ã‚¸ãƒã‚¹ ãƒªãƒ¼ãƒ€ãƒ¼",
        theme: "confident CEO in modern office",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "mid-body shot",
        angle: "three-quarter view",
        lighting: "cinematic key light",
        background: "minimal studio background",
        ar: "16:9",
        stylize: 100,
        chaos: 0,
        quality: 1,
        raw: true
      },
      {
        name: "ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰",
        theme: "powerful wizard casting spell",
        personTemplate: "elderly person, wise expression, wrinkled face",
        composition: "portrait shot",
        angle: "front view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "1:1",
        stylize: 250,
        chaos: 30,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚¹ãƒˆãƒªãƒ¼ãƒˆ ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ",
        theme: "urban street style photographer",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "mid-body shot",
        angle: "side view",
        lighting: "soft window light",
        background: "cafe street background",
        ar: "4:3",
        stylize: 150,
        chaos: 10,
        quality: 1,
        raw: true
      },
      {
        name: "ãƒŠãƒãƒ¥ãƒ©ãƒ« ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼",
        theme: "natural beauty in sunlight",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "close-up shot",
        angle: "three-quarter view",
        lighting: "soft window light",
        background: "minimal studio background",
        ar: "3:2",
        stylize: 100,
        chaos: 0,
        quality: 2,
        raw: true
      },
      {
        name: "å­ä¾›ã®ç¬‘é¡”",
        theme: "happy child playing in park",
        personTemplate: "child, innocent eyes, playful expression",
        composition: "portrait shot",
        angle: "front view",
        lighting: "soft window light",
        background: "cafe street background",
        ar: "1:1",
        stylize: 100,
        chaos: 0,
        quality: 1,
        raw: false
      },
      {
        name: "ãƒ€ãƒ¼ã‚¯ãƒ’ãƒ¼ãƒ­ãƒ¼",
        theme: "mysterious dark hero in shadows",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "full-body shot",
        angle: "three-quarter view",
        lighting: "neon rim lighting",
        background: "city night background",
        ar: "9:16",
        stylize: 200,
        chaos: 40,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚¨ãƒ«ãƒ•ã®æˆ¦å£«",
        theme: "elven warrior with bow and arrow",
        personTemplate: "fantasy character, unique features, mystical appearance",
        composition: "full-body shot",
        angle: "side view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "9:16",
        stylize: 300,
        chaos: 20,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚«ãƒ•ã‚§ã®å°‘å¥³",
        theme: "young woman reading book in cafe",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "mid-body shot",
        angle: "over-shoulder view",
        lighting: "soft window light",
        background: "cafe street background",
        ar: "16:9",
        stylize: 150,
        chaos: 0,
        quality: 1,
        raw: true
      },
      {
        name: "è€è³¢è€…",
        theme: "ancient sage with wisdom in eyes",
        personTemplate: "elderly person, wise expression, wrinkled face",
        composition: "close-up shot",
        angle: "front view",
        lighting: "cinematic key light",
        background: "minimal studio background",
        ar: "1:1",
        stylize: 200,
        chaos: 10,
        quality: 2,
        raw: false
      },
      {
        name: "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ãƒ’ãƒ¼ãƒ­ãƒ¼",
        theme: "action hero in dynamic pose",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "full-body shot",
        angle: "three-quarter view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "16:9",
        stylize: 150,
        chaos: 30,
        quality: 1,
        raw: true
      },
      {
        name: "é­”æ³•å°‘å¥³",
        theme: "magical girl with glowing powers",
        personTemplate: "fantasy character, unique features, mystical appearance",
        composition: "portrait shot",
        angle: "front view",
        lighting: "neon rim lighting",
        background: "city night background",
        ar: "9:16",
        stylize: 250,
        chaos: 20,
        quality: 1,
        raw: false
      },
      {
        name: "ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«",
        theme: "professional business portrait",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "portrait shot",
        angle: "front view",
        lighting: "studio beauty lighting",
        background: "minimal studio background",
        ar: "3:2",
        stylize: 100,
        chaos: 0,
        quality: 2,
        raw: true
      },
      {
        name: "ã‚µãƒ ãƒ©ã‚¤",
        theme: "samurai warrior with katana",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "full-body shot",
        angle: "side view",
        lighting: "cinematic key light",
        background: "minimal studio background",
        ar: "9:16",
        stylize: 200,
        chaos: 20,
        quality: 1,
        raw: false
      },
      {
        name: "å¤©ä½¿",
        theme: "angel with glowing wings",
        personTemplate: "fantasy character, unique features, mystical appearance",
        composition: "full-body shot",
        angle: "front view",
        lighting: "soft window light",
        background: "minimal studio background",
        ar: "2:3",
        stylize: 300,
        chaos: 10,
        quality: 1,
        raw: false
      },
      {
        name: "ãƒ­ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼",
        theme: "rock star performing on stage",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "mid-body shot",
        angle: "three-quarter view",
        lighting: "neon rim lighting",
        background: "city night background",
        ar: "16:9",
        stylize: 200,
        chaos: 30,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚¹ãƒ‘ã‚¤",
        theme: "secret agent in tactical gear",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "full-body shot",
        angle: "three-quarter view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "9:16",
        stylize: 150,
        chaos: 20,
        quality: 1,
        raw: true
      },
      {
        name: "ãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼",
        theme: "dragon rider with magical armor",
        personTemplate: "fantasy character, unique features, mystical appearance",
        composition: "portrait shot",
        angle: "front view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "1:1",
        stylize: 300,
        chaos: 40,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚«ãƒ•ã‚§ã‚ªãƒ¼ãƒŠãƒ¼",
        theme: "friendly cafe owner serving coffee",
        personTemplate: "elderly person, wise expression, wrinkled face",
        composition: "mid-body shot",
        angle: "over-shoulder view",
        lighting: "soft window light",
        background: "cafe street background",
        ar: "4:3",
        stylize: 100,
        chaos: 0,
        quality: 1,
        raw: true
      }
    ];

    document.addEventListener('DOMContentLoaded', function() {
      loadPresets();
      displayPresets();
      restoreLastState();
      setupAutoSave();
    });

    function loadPresets() {
      const stored = localStorage.getItem('mjPresets');
      if (!stored) localStorage.setItem('mjPresets', JSON.stringify(samplePresets));
    }

    function displayPresets() {
      const presetList = document.getElementById('presetList');
      const stored = localStorage.getItem('mjPresets');
      const presets = stored ? JSON.parse(stored) : samplePresets;

      presetList.innerHTML = '';

      presets.forEach((preset, index) => {
        const div = document.createElement('div');
        div.className = 'preset-item';
        div.innerHTML = `<h4>${preset.name}</h4><p>${preset.theme}</p>`;

        // âœ… iPhoneã§ã‚¿ãƒƒãƒ—ã‚’å–ã‚Šã“ã¼ã—ã«ãã„ã‚ˆã†ã« click + touchend ã‚’ä¸¡æ–¹ä»˜ã‘ã‚‹
        div.addEventListener('click', () => loadPreset(index), { passive: true });
        div.addEventListener('touchend', (e) => {
          e.preventDefault(); // iOSã§ã®ã€Œã‚¿ãƒƒãƒ—ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ‰±ã„ã€ã«ãªã‚‹ã®ã‚’æŠ‘åˆ¶
          loadPreset(index);
        }, { passive: false });

        presetList.appendChild(div);
      });
    }

    function loadPreset(index) {
      const stored = localStorage.getItem('mjPresets');
      const presets = stored ? JSON.parse(stored) : samplePresets;
      const preset = presets[index];

      document.getElementById('theme').value = preset.theme || '';
      document.getElementById('personTemplate').value = preset.personTemplate || '';
      document.getElementById('composition').value = preset.composition || 'portrait shot';
      document.getElementById('angle').value = preset.angle || 'front view';
      document.getElementById('lighting').value = preset.lighting || 'soft window light';
      document.getElementById('background').value = preset.background || 'minimal studio background';
      document.getElementById('ar').value = preset.ar || '1:1';
      document.getElementById('stylize').value = preset.stylize ?? 100;
      document.getElementById('chaos').value = preset.chaos ?? 0;
      document.getElementById('quality').value = preset.quality ?? 1;
      document.getElementById('raw').checked = !!preset.raw;
      document.getElementById('seed').value = preset.seed || '';
      document.getElementById('sref').value = preset.sref || '';
      document.getElementById('cref').value = preset.cref || '';

      generatePrompt();
      showToast(`"${preset.name}" ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      saveCurrentState();
    }

    function generatePrompt() {
      const theme = document.getElementById('theme').value.trim();
      const personTemplate = document.getElementById('personTemplate').value.trim();
      const composition = document.getElementById('composition').value.trim();
      const angle = document.getElementById('angle').value.trim();
      const lighting = document.getElementById('lighting').value.trim();
      const background = document.getElementById('background').value.trim();

      let promptParts = [];
      if (theme) promptParts.push(theme);
      if (personTemplate) promptParts.push(personTemplate);
      if (composition) promptParts.push(composition);
      if (angle) promptParts.push(angle);
      if (lighting) promptParts.push(lighting);
      if (background) promptParts.push(background);

      let prompt = promptParts.join(', ');

      const ar = document.getElementById('ar').value;
      const stylize = document.getElementById('stylize').value;
      const chaos = document.getElementById('chaos').value;
      const quality = document.getElementById('quality').value;
      const raw = document.getElementById('raw').checked;
      const seed = document.getElementById('seed').value;
      const sref = document.getElementById('sref').value.trim();
      const cref = document.getElementById('cref').value.trim();

      let params = [];
      if (ar) params.push(`--ar ${ar}`);
      if (stylize !== '' && stylize !== null && stylize !== undefined) params.push(`--stylize ${stylize}`);
      if (chaos && chaos != 0) params.push(`--chaos ${chaos}`);
      if (quality) params.push(`--quality ${quality}`);
      if (raw) params.push(`--style raw`);
      if (seed) params.push(`--seed ${seed}`);
      if (sref) params.push(`--sref ${sref}`);
      if (cref) params.push(`--cref ${cref}`);

      const fullPrompt = prompt + (params.length > 0 ? ' ' + params.join(' ') : '');
      document.getElementById('output').textContent = fullPrompt || 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';

      saveCurrentState();
    }

    function copyToClipboard() {
      const output = document.getElementById('output').textContent;
      if (output && output !== 'ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...' &&
          output !== 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚') {

        // âœ… iOS Safariã§å¤±æ•—ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã®ã§ fallbackä»˜ã
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(output).then(() => {
            showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
          }).catch(() => fallbackCopy(output));
        } else {
          fallbackCopy(output);
        }
      } else {
        showToast('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
      }
    }

    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try {
        document.execCommand('copy');
        showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      } catch (err) {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
      }
      document.body.removeChild(ta);
    }

    function savePreset() {
      const name = prompt('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!name) return;

      const preset = {
        name: name,
        theme: document.getElementById('theme').value,
        personTemplate: document.getElementById('personTemplate').value,
        composition: document.getElementById('composition').value,
        angle: document.getElementById('angle').value,
        lighting: document.getElementById('lighting').value,
        background: document.getElementById('background').value,
        ar: document.getElementById('ar').value,
        stylize: parseInt(document.getElementById('stylize').value || '100', 10),
        chaos: parseInt(document.getElementById('chaos').value || '0', 10),
        quality: parseFloat(document.getElementById('quality').value || '1'),
        raw: document.getElementById('raw').checked,
        seed: document.getElementById('seed').value,
        sref: document.getElementById('sref').value,
        cref: document.getElementById('cref').value
      };

      const stored = localStorage.getItem('mjPresets');
      const presets = stored ? JSON.parse(stored) : samplePresets;
      presets.unshift(preset);
      localStorage.setItem('mjPresets', JSON.stringify(presets));

      displayPresets();
      showToast(`"${name}" ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    function saveCurrentState() {
      const currentState = {
        theme: document.getElementById('theme').value,
        personTemplate: document.getElementById('personTemplate').value,
        composition: document.getElementById('composition').value,
        angle: document.getElementById('angle').value,
        lighting: document.getElementById('lighting').value,
        background: document.getElementById('background').value,
        ar: document.getElementById('ar').value,
        stylize: document.getElementById('stylize').value,
        chaos: document.getElementById('chaos').value,
        quality: document.getElementById('quality').value,
        raw: document.getElementById('raw').checked,
        seed: document.getElementById('seed').value,
        sref: document.getElementById('sref').value,
        cref: document.getElementById('cref').value,
        // âœ… outputã‚‚ä¿å­˜ï¼ˆæ›´æ–°å¾Œã«ã€Œè¡¨ç¤ºãŒæ¶ˆãˆãŸã€æ„Ÿã‚’ãªãã™ï¼‰
        output: document.getElementById('output').textContent
      };
      localStorage.setItem('mjLastState', JSON.stringify(currentState));
    }

    function restoreLastState() {
      const stored = localStorage.getItem('mjLastState');
      if (!stored) return;

      try {
        const state = JSON.parse(stored);

        document.getElementById('theme').value = state.theme || '';
        document.getElementById('personTemplate').value = state.personTemplate || '';
        document.getElementById('composition').value = state.composition || 'close-up shot';
        document.getElementById('angle').value = state.angle || 'front view';
        document.getElementById('lighting').value = state.lighting || 'soft window light';
        document.getElementById('background').value = state.background || 'city night background';
        document.getElementById('ar').value = state.ar || '1:1';
        document.getElementById('stylize').value = state.stylize ?? 100;
        document.getElementById('chaos').value = state.chaos ?? 0;
        document.getElementById('quality').value = state.quality ?? 1;
        document.getElementById('raw').checked = !!state.raw;
        document.getElementById('seed').value = state.seed || '';
        document.getElementById('sref').value = state.sref || '';
        document.getElementById('cref').value = state.cref || '';

        // âœ… ä»¥å‰ã®å‡ºåŠ›ãŒæ®‹ã£ã¦ã„ã‚Œã°è¡¨ç¤ºï¼ˆãƒ†ãƒ¼ãƒãŒç©ºã§ã‚‚è¡¨ç¤ºã¯æ®‹ã‚‹ï¼‰
        if (state.output && state.output !== 'ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...') {
          document.getElementById('output').textContent = state.output;
        } else if (state.theme) {
          generatePrompt();
        }
      } catch (e) {
        console.error('çŠ¶æ…‹ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
      }
    }

    function setupAutoSave() {
      const fields = [
        'theme','personTemplate','composition','angle',
        'lighting','background','ar','stylize',
        'chaos','quality','raw','seed','sref','cref'
      ];

      fields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (!el) return;

        el.addEventListener('input', () => {
          saveCurrentState();
          // å¤‰æ›´ã®ãŸã³ã«è¡¨ç¤ºã‚‚è¿½å¾“ï¼ˆä»»æ„ã ãŒä½¿ã„å‹æ‰‹ãŒä¸ŠãŒã‚‹ï¼‰
          // themeãŒç©ºã®å ´åˆã¯ã€Œè‡ªå‹•ç”Ÿæˆã—ãªã„ã€ã“ã¨ã§ã†ã£ã¨ã†ã—ã•ã‚’é¿ã‘ã‚‹
          if (fieldId !== 'seed' && fieldId !== 'sref' && fieldId !== 'cref') {
            if (document.getElementById('theme').value.trim()) generatePrompt();
          }
        });

        el.addEventListener('change', () => {
          saveCurrentState();
          if (document.getElementById('theme').value.trim()) generatePrompt();
        });
      });
    }

    // âœ… ç”»é¢å›è»¢ãƒ»ãƒªã‚µã‚¤ã‚ºæ™‚ã«æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå‡ºãªã„ã‚ˆã†ä¿é™º
    window.addEventListener('resize', () => {
      document.documentElement.scrollLeft = 0;
      document.body.scrollLeft = 0;
    }, { passive: true });
  </script>
</body>
</html>
