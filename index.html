<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Midjourney Prompt Builder</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden; /* ãƒšãƒ¼ã‚¸è‡ªä½“ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯æŠ‘åˆ¶ */
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 { font-size: 2rem; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 0.95rem; }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }

    .section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      min-width: 0; /* iOS/Chromiumã®ã‚°ãƒªãƒƒãƒ‰å†…æº¢ã‚Œå¯¾ç­– */
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.3rem;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group { margin-bottom: 20px; }

    label {
      display: block;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s;
      max-width: 100%;
      background: #fff;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      padding: 14px 18px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      touch-action: manipulation;
      min-width: 160px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }

    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }

    .btn-light { background: #e9ecef; color: #333; }
    .btn-light:hover { background: #dde2e6; }

    .output-editor {
      background: #fff;
      border: 2px solid #667eea;
      border-radius: 12px;
      padding: 12px;
      min-height: 170px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95rem;
      line-height: 1.6;
      color: #333;

      /* é•·æ–‡ã§ãƒšãƒ¼ã‚¸ãŒæ¨ªã«ä¼¸ã³ãªã„ã‚ˆã†ã«ã™ã‚‹ */
      overflow-x: auto;
      overflow-y: auto;
      max-height: 260px;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-word;
      -webkit-overflow-scrolling: touch;

      resize: vertical;
    }

    .preset-list {
      max-height: 400px;
      overflow-y: auto;
      overflow-x: hidden;
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      -webkit-overflow-scrolling: touch;
    }

    .preset-item {
      padding: 12px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid #667eea;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .preset-item:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }

    .preset-item h4 {
      color: #667eea;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .preset-item p {
      color: #666;
      font-size: 0.85rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      animation: slideIn 0.3s;
      max-width: min(520px, calc(100vw - 40px));
      line-height: 1.4;
    }
    .toast.error { background: #dc3545; }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .param-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .small-text {
      font-size: 0.8rem;
      color: #888;
      margin-top: 5px;
    }

    /* é•·ã„URLå…¥åŠ›ã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå£Šã‚Œãªã„ã‚ˆã†ã« */
    input[type="text"] {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .pill-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .pill {
      padding: 10px 12px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .pill input[type="radio"] { width: 18px; height: 18px; }
    .pill strong { font-size: 0.9rem; }

    .divider {
      height: 1px;
      background: #dde2e6;
      margin: 18px 0;
      border-radius: 999px;
    }

    /* Copyå¤±æ•—æ™‚ã®æ‰‹å‹•ã‚³ãƒ”ãƒ¼æ¡ˆå†…ãƒãƒ¼ */
    .copy-helper {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      width: min(920px, calc(100vw - 24px));
      background: rgba(20, 20, 20, 0.92);
      color: #fff;
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      z-index: 1200;
      display: none;
    }

    .copy-helper .row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .copy-helper .title {
      font-weight: 800;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }
    .copy-helper .desc {
      opacity: 0.95;
      line-height: 1.35;
      font-size: 0.9rem;
    }

    .copy-helper button {
      flex: none;
      min-width: auto;
      padding: 10px 12px;
      font-size: 0.9rem;
      border-radius: 10px;
      background: #fff;
      color: #111;
    }
    .copy-helper button:hover { background: #f1f3f5; }

    /* ===== Aæ¡ˆï¼šsref/crefã‚’textareaåŒ–ã—ã¦â€œç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«â€ ===== */
    .url-textarea {
      min-height: 48px;       /* rows=2ç›¸å½“ã®è¦‹ãŸç›® */
      max-height: 160px;      /* ä¼¸ã³ã™ãé˜²æ­¢ */
      resize: vertical;       /* å¿…è¦ãªã‚‰ä¼¸ã°ã›ã‚‹ */
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;  /* æŠ˜ã‚Šè¿”ã— */
      overflow-wrap: anywhere;
      word-break: break-word;
      -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 1024px) {
      .main-content { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.5rem; }
      .param-grid { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      body { padding: 10px; }
      .main-content { padding: 15px; gap: 15px; }
      .section { padding: 15px; }
      .output-editor { max-height: 320px; }
      button { min-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¨ Midjourney Prompt Builder</h1>
      <p>ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªMidjourneyãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç°¡å˜ã«ä½œæˆ</p>
    </div>

    <div class="main-content">
      <!-- å·¦å´ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="section">
        <h2>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</h2>

        <div class="form-group">
          <label for="theme">ãƒ†ãƒ¼ãƒ / Theme</label>
          <input type="text" id="theme" placeholder="ä¾‹: a cyberpunk warrior in neon city" />
        </div>

        <div class="form-group">
          <label for="personTemplate">äººç‰©ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ / Person Template</label>
          <select id="personTemplate">
            <option value="">ãªã— / None</option>
            <option value="beautiful young woman, detailed face, expressive eyes">Beautiful Young Woman</option>
            <option value="handsome man, sharp jawline, confident expression">Handsome Man</option>
            <option value="elderly person, wise expression, wrinkled face">Elderly Person</option>
            <option value="child, innocent eyes, playful expression">Child</option>
            <option value="fantasy character, unique features, mystical appearance">Fantasy Character</option>
          </select>
        </div>

        <div class="param-grid">
          <div class="form-group">
            <label for="composition">æ§‹å›³ / Composition</label>
            <select id="composition">
              <option value="close-up shot">Close-up</option>
              <option value="portrait shot">Portrait</option>
              <option value="mid-body shot">Mid-body</option>
              <option value="full-body shot">Full-body</option>
            </select>
          </div>

          <div class="form-group">
            <label for="angle">ã‚¢ãƒ³ã‚°ãƒ« / Angle</label>
            <select id="angle">
              <option value="front view">Front</option>
              <option value="three-quarter view">Three-quarter</option>
              <option value="side view">Side</option>
              <option value="over-shoulder view">Over-shoulder</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="lighting">ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚° / Lighting</label>
          <select id="lighting">
            <option value="soft window light">Soft Window Light</option>
            <option value="neon rim lighting">Neon Rim Lighting</option>
            <option value="cinematic key light">Cinematic Key Light</option>
            <option value="studio beauty lighting">Studio Beauty Lighting</option>
          </select>
        </div>

        <div class="form-group">
          <label for="background">èƒŒæ™¯ / Background</label>
          <select id="background">
            <option value="city night background">City Night</option>
            <option value="minimal studio background">Minimal Studio</option>
            <option value="cafe street background">Cafe Street</option>
          </select>
        </div>

        <h2 style="margin-top: 30px;">âš™ï¸ Midjourneyãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h2>

        <div class="param-grid">
          <div class="form-group">
            <label for="ar">ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” / --ar</label>
            <select id="ar">
              <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
              <option value="16:9">16:9 (æ¨ªé•·)</option>
              <option value="9:16" selected>9:16 (ç¸¦é•·)</option>
              <option value="4:3">4:3</option>
              <option value="3:2">3:2</option>
              <option value="2:3">2:3</option>
              <option value="custom">Custom</option>
            </select>

            <div class="form-group" id="arCustomWrap" style="display:none; margin-top:10px;">
              <label for="arCustom">ã‚«ã‚¹ã‚¿ãƒ æ¯”ç‡ï¼ˆä¾‹: 7:10ï¼‰</label>
              <input type="text" id="arCustom" placeholder="ä¾‹: 7:10" />
              <div class="small-text">å½¢å¼ã¯ã€Œæ•°å­—:æ•°å­—ã€</div>
            </div>
          </div>

          <div class="form-group">
            <label for="stylize">ã‚¹ã‚¿ã‚¤ãƒ©ã‚¤ã‚º / --stylize</label>
            <input type="number" id="stylize" min="0" max="1000" value="100" step="50" />
            <div class="small-text">0-1000 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100)</div>
          </div>

          <div class="form-group">
            <label for="chaos">ã‚«ã‚ªã‚¹ / --chaos</label>
            <input type="number" id="chaos" min="0" max="100" value="0" step="10" />
            <div class="small-text">0-100 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0)</div>
          </div>

          <div class="form-group">
            <label for="quality">å“è³ª / --quality</label>
            <select id="quality">
              <option value="0.25">0.25 (ä½é€Ÿ)</option>
              <option value="0.5">0.5</option>
              <option value="1" selected>1 (æ¨™æº–)</option>
              <option value="2">2 (é«˜å“è³ª)</option>
            </select>
          </div>
        </div>

        <!-- RAW è¡¨è¨˜åˆ‡æ›¿ï¼ˆ--style raw / --rawï¼‰ -->
        <div class="form-group">
          <label>RAWè¡¨è¨˜ï¼ˆåˆ‡æ›¿ï¼‰</label>
          <div class="pill-row" role="radiogroup" aria-label="RAWè¡¨è¨˜åˆ‡æ›¿">
            <label class="pill" for="rawStyle">
              <input type="radio" name="rawMode" id="rawStyle" value="style" checked />
              <strong>--style raw</strong>
            </label>
            <label class="pill" for="rawRaw">
              <input type="radio" name="rawMode" id="rawRaw" value="raw" />
              <strong>--raw</strong>
            </label>
          </div>
          <div class="checkbox-group" style="margin-top: 10px;">
            <input type="checkbox" id="raw" />
            <label for="raw" style="margin-bottom: 0;">RAWãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–</label>
          </div>
          <div class="small-text">Midjourneyå´ã§è‡ªå‹•å¤‰æ›ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆã©ã¡ã‚‰ã§ã‚‚OKï¼‰ã€‚</div>
        </div>

        <div class="form-group">
          <label for="seed">ã‚·ãƒ¼ãƒ‰ / --seed (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
          <input type="number" id="seed" placeholder="ä¾‹: 12345" />
          <div class="small-text">åŒã˜ã‚·ãƒ¼ãƒ‰ã§ä¸€è²«ã—ãŸçµæœ</div>
        </div>

        <!-- ===== Aæ¡ˆï¼šsref/crefã‚’textareaåŒ– ===== -->
        <div class="form-group">
          <label for="sref">ã‚¹ã‚¿ã‚¤ãƒ«å‚ç…§ / --sref (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
          <textarea id="sref" class="url-textarea" rows="2" placeholder="ç”»åƒURL" spellcheck="false"></textarea>
          <div class="small-text">ã‚¹ã‚¿ã‚¤ãƒ«å‚ç…§ç”»åƒã®URLï¼ˆé•·ã„URLã¯ã“ã®æ¬„ã®ä¸­ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ï¼‰</div>
        </div>

        <div class="form-group">
          <label for="cref">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‚ç…§ / --cref (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
          <textarea id="cref" class="url-textarea" rows="2" placeholder="ç”»åƒURL" spellcheck="false"></textarea>
          <div class="small-text">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‚ç…§ç”»åƒã®URLï¼ˆé•·ã„URLã¯ã“ã®æ¬„ã®ä¸­ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ï¼‰</div>
        </div>

        <div class="divider"></div>

        <div class="button-group">
          <button class="btn-primary" type="button" id="btnGenerate">âœ¨ Generate</button>
          <button class="btn-success" type="button" id="btnSave">ğŸ’¾ Save</button>
        </div>
      </div>

      <!-- å³å´ï¼šå‡ºåŠ›ã¨ãƒ—ãƒªã‚»ãƒƒãƒˆ -->
      <div class="section">
        <h2>ğŸ¯ ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆç·¨é›†OKï¼‰</h2>

        <!-- å‡ºåŠ›ï¼ç·¨é›†å¯èƒ½ -->
        <textarea class="output-editor" id="outputEditor" spellcheck="false">ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</textarea>

        <div class="button-group">
          <button class="btn-secondary" type="button" id="btnCopy">ğŸ“‹ Copy to Clipboard</button>
          <button class="btn-light" type="button" id="btnRebuild">ğŸ§© Rebuild from Settings</button>
        </div>

        <div class="small-text" style="margin-top: 8px;">
          â€» Copyã¯ã“ã®ç·¨é›†æ¬„ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚<br>
          â€» Rebuildã¯å·¦ã®è¨­å®šã‹ã‚‰å†ç”Ÿæˆã—ã¦ã€ã“ã®æ¬„ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚
        </div>

        <h2 style="margin-top: 30px;">ğŸ“š ãƒ—ãƒªã‚»ãƒƒãƒˆ</h2>
        <div class="preset-list" id="presetList"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

  <!-- Copyå¤±æ•—æ™‚ã®æ‰‹å‹•ã‚³ãƒ”ãƒ¼æ¡ˆå†…ï¼ˆå›ºå®šãƒãƒ¼ï¼‰ -->
  <div class="copy-helper" id="copyHelper" aria-live="polite">
    <div class="row">
      <div>
        <div class="title">ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆiPhone/Safariå¯¾ç­–ï¼‰</div>
        <div class="desc">å‡ºåŠ›æ¬„ã‚’é•·æŠ¼ã— â†’ å…¨é¸æŠ â†’ ã‚³ãƒ”ãƒ¼ ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ä»Šã€å‡ºåŠ›æ¬„ã‚’è‡ªå‹•ã§é¸æŠçŠ¶æ…‹ã«ã—ã¦ã„ã¾ã™ã€‚</div>
      </div>
      <button type="button" id="btnCopyHelpClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    // ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆ20å€‹ï¼‰
    const samplePresets = [
      {
        name: "ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ",
        theme: "cyberpunk warrior with glowing tattoos",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "portrait shot",
        angle: "three-quarter view",
        lighting: "neon rim lighting",
        background: "city night background",
        ar: "9:16",
        stylize: 150,
        chaos: 20,
        quality: 1,
        raw: true
      },
      {
        name: "ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆ ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³",
        theme: "elegant fashion model in luxury dress",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "full-body shot",
        angle: "front view",
        lighting: "studio beauty lighting",
        background: "minimal studio background",
        ar: "2:3",
        stylize: 200,
        chaos: 0,
        quality: 2,
        raw: false
      },
      {
        name: "ãƒ“ã‚¸ãƒã‚¹ ãƒªãƒ¼ãƒ€ãƒ¼",
        theme: "confident CEO in modern office",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "mid-body shot",
        angle: "three-quarter view",
        lighting: "cinematic key light",
        background: "minimal studio background",
        ar: "16:9",
        stylize: 100,
        chaos: 0,
        quality: 1,
        raw: true
      },
      {
        name: "ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰",
        theme: "powerful wizard casting spell",
        personTemplate: "elderly person, wise expression, wrinkled face",
        composition: "portrait shot",
        angle: "front view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "1:1",
        stylize: 250,
        chaos: 30,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚¹ãƒˆãƒªãƒ¼ãƒˆ ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ",
        theme: "urban street style photographer",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "mid-body shot",
        angle: "side view",
        lighting: "soft window light",
        background: "cafe street background",
        ar: "4:3",
        stylize: 150,
        chaos: 10,
        quality: 1,
        raw: true
      },
      {
        name: "ãƒŠãƒãƒ¥ãƒ©ãƒ« ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼",
        theme: "natural beauty in sunlight",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "close-up shot",
        angle: "three-quarter view",
        lighting: "soft window light",
        background: "minimal studio background",
        ar: "3:2",
        stylize: 100,
        chaos: 0,
        quality: 2,
        raw: true
      },
      {
        name: "å­ä¾›ã®ç¬‘é¡”",
        theme: "happy child playing in park",
        personTemplate: "child, innocent eyes, playful expression",
        composition: "portrait shot",
        angle: "front view",
        lighting: "soft window light",
        background: "cafe street background",
        ar: "1:1",
        stylize: 100,
        chaos: 0,
        quality: 1,
        raw: false
      },
      {
        name: "ãƒ€ãƒ¼ã‚¯ãƒ’ãƒ¼ãƒ­ãƒ¼",
        theme: "mysterious dark hero in shadows",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "full-body shot",
        angle: "three-quarter view",
        lighting: "neon rim lighting",
        background: "city night background",
        ar: "9:16",
        stylize: 200,
        chaos: 40,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚¨ãƒ«ãƒ•ã®æˆ¦å£«",
        theme: "elven warrior with bow and arrow",
        personTemplate: "fantasy character, unique features, mystical appearance",
        composition: "full-body shot",
        angle: "side view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "9:16",
        stylize: 300,
        chaos: 20,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚«ãƒ•ã‚§ã®å°‘å¥³",
        theme: "young woman reading book in cafe",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "mid-body shot",
        angle: "over-shoulder view",
        lighting: "soft window light",
        background: "cafe street background",
        ar: "16:9",
        stylize: 150,
        chaos: 0,
        quality: 1,
        raw: true
      },
      {
        name: "è€è³¢è€…",
        theme: "ancient sage with wisdom in eyes",
        personTemplate: "elderly person, wise expression, wrinkled face",
        composition: "close-up shot",
        angle: "front view",
        lighting: "cinematic key light",
        background: "minimal studio background",
        ar: "1:1",
        stylize: 200,
        chaos: 10,
        quality: 2,
        raw: false
      },
      {
        name: "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ãƒ’ãƒ¼ãƒ­ãƒ¼",
        theme: "action hero in dynamic pose",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "full-body shot",
        angle: "three-quarter view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "16:9",
        stylize: 150,
        chaos: 30,
        quality: 1,
        raw: true
      },
      {
        name: "é­”æ³•å°‘å¥³",
        theme: "magical girl with glowing powers",
        personTemplate: "fantasy character, unique features, mystical appearance",
        composition: "portrait shot",
        angle: "front view",
        lighting: "neon rim lighting",
        background: "city night background",
        ar: "9:16",
        stylize: 250,
        chaos: 20,
        quality: 1,
        raw: false
      },
      {
        name: "ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«",
        theme: "professional business portrait",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "portrait shot",
        angle: "front view",
        lighting: "studio beauty lighting",
        background: "minimal studio background",
        ar: "3:2",
        stylize: 100,
        chaos: 0,
        quality: 2,
        raw: true
      },
      {
        name: "ã‚µãƒ ãƒ©ã‚¤",
        theme: "samurai warrior with katana",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "full-body shot",
        angle: "side view",
        lighting: "cinematic key light",
        background: "minimal studio background",
        ar: "9:16",
        stylize: 200,
        chaos: 20,
        quality: 1,
        raw: false
      },
      {
        name: "å¤©ä½¿",
        theme: "angel with glowing wings",
        personTemplate: "fantasy character, unique features, mystical appearance",
        composition: "full-body shot",
        angle: "front view",
        lighting: "soft window light",
        background: "minimal studio background",
        ar: "2:3",
        stylize: 300,
        chaos: 10,
        quality: 1,
        raw: false
      },
      {
        name: "ãƒ­ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼",
        theme: "rock star performing on stage",
        personTemplate: "handsome man, sharp jawline, confident expression",
        composition: "mid-body shot",
        angle: "three-quarter view",
        lighting: "neon rim lighting",
        background: "city night background",
        ar: "16:9",
        stylize: 200,
        chaos: 30,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚¹ãƒ‘ã‚¤",
        theme: "secret agent in tactical gear",
        personTemplate: "beautiful young woman, detailed face, expressive eyes",
        composition: "full-body shot",
        angle: "three-quarter view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "9:16",
        stylize: 150,
        chaos: 20,
        quality: 1,
        raw: true
      },
      {
        name: "ãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼",
        theme: "dragon rider with magical armor",
        personTemplate: "fantasy character, unique features, mystical appearance",
        composition: "portrait shot",
        angle: "front view",
        lighting: "cinematic key light",
        background: "city night background",
        ar: "1:1",
        stylize: 300,
        chaos: 40,
        quality: 1,
        raw: false
      },
      {
        name: "ã‚«ãƒ•ã‚§ã‚ªãƒ¼ãƒŠãƒ¼",
        theme: "friendly cafe owner serving coffee",
        personTemplate: "elderly person, wise expression, wrinkled face",
        composition: "mid-body shot",
        angle: "over-shoulder view",
        lighting: "soft window light",
        background: "cafe street background",
        ar: "4:3",
        stylize: 100,
        chaos: 0,
        quality: 1,
        raw: true
      }
    ];

    // ===== çŠ¶æ…‹ç®¡ç†ã‚­ãƒ¼ =====
    const KEY_PRESETS = 'mjPresets';
    const KEY_LAST_STATE = 'mjLastState';
    const KEY_EDITOR = 'mjOutputEditorText';
    const KEY_RAW_MODE = 'mjRawMode'; // "style" | "raw"

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function () {
      loadPresets();
      displayPresets();
      restoreLastState();
      restoreEditorText();
      setupButtons();
      setupARCustomToggle();
      setupAutoSave();

      // åˆå›ã‚‚ä¸€å›ç”Ÿæˆã—ã¦ãŠãï¼ˆãƒ†ãƒ¼ãƒç­‰ãŒç©ºã§ã‚‚OKï¼‰
      generatePrompt({ silentToast: true });
    });

    function setupButtons() {
      document.getElementById('btnGenerate').addEventListener('click', () => generatePrompt());
      document.getElementById('btnSave').addEventListener('click', savePreset);
      document.getElementById('btnCopy').addEventListener('click', copyToClipboard);

      document.getElementById('btnRebuild').addEventListener('click', () => {
        generatePrompt({ overwriteEditor: true, fromRebuild: true });
        showToast('å·¦ã®è¨­å®šã‹ã‚‰å†ç”Ÿæˆã—ã¾ã—ãŸ');
      });

      document.getElementById('btnCopyHelpClose').addEventListener('click', hideCopyHelper);

      // RAWè¡¨è¨˜ãƒ©ã‚¸ã‚ª
      const rawStyle = document.getElementById('rawStyle');
      const rawRaw = document.getElementById('rawRaw');

      const storedMode = localStorage.getItem(KEY_RAW_MODE);
      if (storedMode === 'raw') rawRaw.checked = true;
      else rawStyle.checked = true;

      rawStyle.addEventListener('change', () => {
        localStorage.setItem(KEY_RAW_MODE, 'style');
        saveCurrentState();
        generatePrompt({ silentToast: true });
      });
      rawRaw.addEventListener('change', () => {
        localStorage.setItem(KEY_RAW_MODE, 'raw');
        saveCurrentState();
        generatePrompt({ silentToast: true });
      });

      // ã‚¨ãƒ‡ã‚£ã‚¿ç·¨é›†ï¼šä¿å­˜ï¼ˆè»½ã‚ã®debounceï¼‰
      const editor = document.getElementById('outputEditor');
      let t = null;
      editor.addEventListener('input', () => {
        if (t) clearTimeout(t);
        t = setTimeout(() => {
          saveEditorText();
        }, 250);
      });
    }

    // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã€ãªã‘ã‚Œã°ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½¿ç”¨
    function loadPresets() {
      const stored = localStorage.getItem(KEY_PRESETS);
      if (!stored) {
        localStorage.setItem(KEY_PRESETS, JSON.stringify(samplePresets));
      }
    }

    // ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã‚’è¡¨ç¤º
    function displayPresets() {
      const presetList = document.getElementById('presetList');
      const stored = localStorage.getItem(KEY_PRESETS);
      const presets = stored ? JSON.parse(stored) : samplePresets;

      presetList.innerHTML = '';
      presets.forEach((preset, index) => {
        const div = document.createElement('div');
        div.className = 'preset-item';
        div.innerHTML = `
          <h4>${escapeHtml(preset.name)}</h4>
          <p>${escapeHtml(preset.theme || '')}</p>
        `;
        // iPhoneã§ã‚¿ãƒƒãƒ—ãŒåŠ¹ã‹ãªã„ã‚±ãƒ¼ã‚¹å¯¾ç­–ï¼šclick + touchend
        div.addEventListener('click', () => loadPreset(index));
        div.addEventListener('touchend', (e) => { e.preventDefault(); loadPreset(index); }, { passive: false });
        presetList.appendChild(div);
      });
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // ====== Custom AR ======
    function isValidAR(value) {
      return /^[0-9]+:[0-9]+$/.test((value || '').trim());
    }

    function setupARCustomToggle() {
      const arSelect = document.getElementById('ar');
      const wrap = document.getElementById('arCustomWrap');

      function sync() {
        const isCustom = arSelect.value === 'custom';
        wrap.style.display = isCustom ? 'block' : 'none';
      }

      arSelect.addEventListener('change', () => {
        sync();
        saveCurrentState();
        generatePrompt({ silentToast: true });
      });

      sync();
    }

    // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿
    // ä»•æ§˜ï¼šãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´æ™‚ã«sref/cref/seedã¯åŸºæœ¬ç¶­æŒï¼ˆæ¶ˆãˆãªã„ï¼‰
    function loadPreset(index) {
      const stored = localStorage.getItem(KEY_PRESETS);
      const presets = stored ? JSON.parse(stored) : samplePresets;
      const preset = presets[index];

      // ç¾åœ¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å€¤ã‚’é€€é¿ï¼ˆç¶­æŒã—ãŸã„ï¼‰
      const keepSeed = document.getElementById('seed').value;
      const keepSref = document.getElementById('sref').value;
      const keepCref = document.getElementById('cref').value;

      document.getElementById('theme').value = preset.theme || '';
      document.getElementById('personTemplate').value = preset.personTemplate || '';
      document.getElementById('composition').value = preset.composition || 'portrait shot';
      document.getElementById('angle').value = preset.angle || 'front view';
      document.getElementById('lighting').value = preset.lighting || 'soft window light';
      document.getElementById('background').value = preset.background || 'minimal studio background';

      // arï¼šcustomã®å ´åˆã‚‚è€ƒæ…®ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆå´ã¯åŸºæœ¬ fixed æƒ³å®šï¼‰
      if (preset.ar && preset.ar !== 'custom') {
        document.getElementById('ar').value = preset.ar;
      } else {
        document.getElementById('ar').value = '9:16';
      }

      // custom ar å€¤ï¼ˆä¿å­˜ã•ã‚Œã¦ã‚‹å ´åˆã ã‘å¾©å…ƒï¼‰
      if (preset.ar === 'custom' && preset.arCustom && isValidAR(preset.arCustom)) {
        document.getElementById('ar').value = 'custom';
        document.getElementById('arCustom').value = preset.arCustom;
      }

      document.getElementById('stylize').value = preset.stylize ?? 100;
      document.getElementById('chaos').value = preset.chaos ?? 0;
      document.getElementById('quality').value = preset.quality ?? 1;
      document.getElementById('raw').checked = preset.raw || false;

      // ç¶­æŒï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆã«æ˜ç¤ºãŒã‚ã‚Œã°ãã‚Œã‚’æ¡ç”¨ã€ãªã‘ã‚Œã°ä¿æŒï¼‰
      document.getElementById('seed').value = (preset.seed !== undefined && preset.seed !== null && preset.seed !== '') ? preset.seed : keepSeed;
      document.getElementById('sref').value = (preset.sref !== undefined && preset.sref !== null && preset.sref !== '') ? preset.sref : keepSref;
      document.getElementById('cref').value = (preset.cref !== undefined && preset.cref !== null && preset.cref !== '') ? preset.cref : keepCref;

      // RAW modeï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆã«ã‚ã‚Œã°é©ç”¨ï¼‰
      if (preset.rawMode) localStorage.setItem(KEY_RAW_MODE, preset.rawMode);

      // ãƒ©ã‚¸ã‚ªçŠ¶æ…‹åæ˜ 
      const mode = getRawMode();
      document.getElementById('rawStyle').checked = (mode === 'style');
      document.getElementById('rawRaw').checked = (mode === 'raw');

      // Custom AR UIåŒæœŸ
      const arSelect = document.getElementById('ar');
      const wrap = document.getElementById('arCustomWrap');
      wrap.style.display = (arSelect.value === 'custom') ? 'block' : 'none';

      // ç”Ÿæˆ â†’ ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šæ›¸ãï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨ãªã®ã§ä¸Šæ›¸ããŒè‡ªç„¶ï¼‰
      generatePrompt({ overwriteEditor: true, silentToast: true });

      saveCurrentState();
      showToast(`"${preset.name}" ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    }

    // ===== RAWè¡¨è¨˜ =====
    function getRawMode() {
      const stored = localStorage.getItem(KEY_RAW_MODE);
      return stored === 'raw' ? 'raw' : 'style';
    }

    // ===== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆå·¦è¨­å®š â†’ æ–‡å­—åˆ—ï¼‰ =====
    function buildPromptString() {
      const theme = document.getElementById('theme').value.trim();
      const personTemplate = document.getElementById('personTemplate').value;
      const composition = document.getElementById('composition').value;
      const angle = document.getElementById('angle').value;
      const lighting = document.getElementById('lighting').value;
      const background = document.getElementById('background').value;

      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ¬æ–‡
      const promptParts = [];
      if (theme) promptParts.push(theme);
      if (personTemplate) promptParts.push(personTemplate);
      if (composition) promptParts.push(composition);
      if (angle) promptParts.push(angle);
      if (lighting) promptParts.push(lighting);
      if (background) promptParts.push(background);

      const prompt = promptParts.join(', ');

      // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      let ar = document.getElementById('ar').value;
      if (ar === 'custom') {
        const custom = document.getElementById('arCustom').value;
        ar = isValidAR(custom) ? custom.trim() : '';
      }

      const stylize = document.getElementById('stylize').value;
      const chaos = document.getElementById('chaos').value;
      const quality = document.getElementById('quality').value;
      const rawEnabled = document.getElementById('raw').checked;
      const seed = document.getElementById('seed').value;
      const sref = document.getElementById('sref').value.trim();
      const cref = document.getElementById('cref').value.trim();

      const params = [];
      if (ar) params.push(`--ar ${ar}`);
      if (stylize !== '' && stylize !== null && stylize !== undefined) params.push(`--stylize ${stylize}`);
      if (chaos && chaos != 0) params.push(`--chaos ${chaos}`);
      if (quality) params.push(`--quality ${quality}`);

      if (rawEnabled) {
        const mode = getRawMode();
        params.push(mode === 'raw' ? `--raw` : `--style raw`);
      }

      if (seed) params.push(`--seed ${seed}`);
      if (sref) params.push(`--sref ${sref}`);
      if (cref) params.push(`--cref ${cref}`);

      const fullPrompt = prompt + (params.length > 0 ? ' ' + params.join(' ') : '');
      return fullPrompt || 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    }

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã¸åæ˜ ï¼‰
    // overwriteEditor: true -> ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šæ›¸ã
    function generatePrompt(opts = {}) {
      const { overwriteEditor = true, silentToast = false } = opts;

      const fullPrompt = buildPromptString();
      const editor = document.getElementById('outputEditor');

      if (overwriteEditor) {
        editor.value = fullPrompt;
        saveEditorText();
      } else {
        // ä¸Šæ›¸ãã—ãªã„å ´åˆï¼šç©ºã®ã¨ãã ã‘å…¥ã‚Œã‚‹
        if (!editor.value || editor.value === 'ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...') {
          editor.value = fullPrompt;
          saveEditorText();
        }
      }

      // ç”Ÿæˆã®ãŸã³ã«ä¿å­˜ï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³/ãƒªãƒ­ãƒ¼ãƒ‰è€æ€§ï¼‰
      saveCurrentState();

      if (!silentToast && fullPrompt && fullPrompt !== 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚') {
        // å¿…è¦ãªã‚‰é€šçŸ¥ï¼ˆã†ã‚‹ã•ã‘ã‚Œã° silentToast ã‚’ä½¿ã†ï¼‰
      }
    }

    // ===== Copy: iPhone/Safariå¯¾ç­–ï¼ˆå¤±æ•—æ™‚ã«æ‰‹å‹•ã‚³ãƒ”ãƒ¼æ¡ˆå†…ï¼‰ =====
    async function copyToClipboard() {
      hideCopyHelper();

      const editor = document.getElementById('outputEditor');
      const text = (editor.value || '').trim();

      if (!text || text === 'ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...' ||
          text === 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚') {
        showToast('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      // å¤±æ•—æ™‚ã«æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã—ã‚„ã™ãã™ã‚‹ï¼štextareaã®å…¨æ–‡é¸æŠ
      function selectEditorText() {
        try {
          editor.focus();
          editor.select();
          editor.setSelectionRange(0, editor.value.length); // iOSå¯¾ç­–
          editor.scrollIntoView({ block: 'center', behavior: 'smooth' });
        } catch (_) {}
      }

      // 1) Clipboard API
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
          return;
        }
      } catch (_) {}

      // 2) execCommand fallback
      try {
        selectEditorText();
        const ok = document.execCommand('copy');
        if (ok) {
          showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
          return;
        }
      } catch (_) {}

      // 3) manual ì•ˆë‚´ï¼ˆå›ºå®šãƒãƒ¼è¡¨ç¤º + è‡ªå‹•é¸æŠï¼‰
      selectEditorText();
      showCopyHelper();
      showToast('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'error');
    }

    function showCopyHelper() {
      const el = document.getElementById('copyHelper');
      el.style.display = 'block';
    }
    function hideCopyHelper() {
      const el = document.getElementById('copyHelper');
      el.style.display = 'none';
    }

    // ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜
    function savePreset() {
      const name = prompt('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!name) return;

      // arï¼ˆcustomãªã‚‰ arCustom ã‚’ä¿å­˜ï¼‰
      let ar = document.getElementById('ar').value;
      let arCustom = '';
      if (ar === 'custom') {
        const custom = document.getElementById('arCustom').value;
        if (isValidAR(custom)) {
          arCustom = custom.trim();
          ar = 'custom';
        } else {
          ar = '9:16';
        }
      }

      const preset = {
        name: name,
        theme: document.getElementById('theme').value,
        personTemplate: document.getElementById('personTemplate').value,
        composition: document.getElementById('composition').value,
        angle: document.getElementById('angle').value,
        lighting: document.getElementById('lighting').value,
        background: document.getElementById('background').value,
        ar: ar,
        arCustom: arCustom,
        stylize: parseInt(document.getElementById('stylize').value, 10),
        chaos: parseInt(document.getElementById('chaos').value, 10),
        quality: parseFloat(document.getElementById('quality').value),
        raw: document.getElementById('raw').checked,
        rawMode: getRawMode(),
        seed: document.getElementById('seed').value,
        sref: document.getElementById('sref').value,
        cref: document.getElementById('cref').value
      };

      const stored = localStorage.getItem(KEY_PRESETS);
      const presets = stored ? JSON.parse(stored) : samplePresets;
      presets.unshift(preset);
      localStorage.setItem(KEY_PRESETS, JSON.stringify(presets));

      displayPresets();
      showToast(`"${name}" ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼ˆsuccess / errorï¼‰
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.classList.remove('error');
      if (type === 'error') toast.classList.add('error');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3500);
    }

    // ===== ã‚¨ãƒ‡ã‚£ã‚¿ä¿å­˜/å¾©å…ƒ =====
    function saveEditorText() {
      const editor = document.getElementById('outputEditor');
      localStorage.setItem(KEY_EDITOR, editor.value || '');
    }

    function restoreEditorText() {
      const stored = localStorage.getItem(KEY_EDITOR);
      if (!stored) return;
      const editor = document.getElementById('outputEditor');
      // åˆæœŸæ–‡è¨€ã®ã¾ã¾ãªã‚‰ä¸Šæ›¸ãã€ã™ã§ã«ä½•ã‹ã‚ã‚Œã°è§¦ã‚‰ãªã„
      if (!editor.value || editor.value === 'ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...') {
        editor.value = stored;
      }
    }

    // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆlocalStorageï¼‰
    function saveCurrentState() {
      const arVal = document.getElementById('ar').value;
      const currentState = {
        theme: document.getElementById('theme').value,
        personTemplate: document.getElementById('personTemplate').value,
        composition: document.getElementById('composition').value,
        angle: document.getElementById('angle').value,
        lighting: document.getElementById('lighting').value,
        background: document.getElementById('background').value,
        ar: arVal,
        arCustom: document.getElementById('arCustom') ? document.getElementById('arCustom').value : '',
        stylize: document.getElementById('stylize').value,
        chaos: document.getElementById('chaos').value,
        quality: document.getElementById('quality').value,
        raw: document.getElementById('raw').checked,
        rawMode: getRawMode(),
        seed: document.getElementById('seed').value,
        sref: document.getElementById('sref').value,
        cref: document.getElementById('cref').value
      };
      localStorage.setItem(KEY_LAST_STATE, JSON.stringify(currentState));
    }

    // å‰å›ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
    function restoreLastState() {
      const stored = localStorage.getItem(KEY_LAST_STATE);
      if (!stored) return;

      try {
        const state = JSON.parse(stored);

        document.getElementById('theme').value = state.theme || '';
        document.getElementById('personTemplate').value = state.personTemplate || '';
        document.getElementById('composition').value = state.composition || 'close-up shot';
        document.getElementById('angle').value = state.angle || 'front view';
        document.getElementById('lighting').value = state.lighting || 'soft window light';
        document.getElementById('background').value = state.background || 'city night background';
        document.getElementById('ar').value = state.ar || '9:16';

        if (document.getElementById('arCustom')) {
          document.getElementById('arCustom').value = state.arCustom || '';
        }
        document.getElementById('arCustomWrap').style.display =
          (document.getElementById('ar').value === 'custom') ? 'block' : 'none';

        document.getElementById('stylize').value = state.stylize || 100;
        document.getElementById('chaos').value = state.chaos || 0;
        document.getElementById('quality').value = state.quality || 1;
        document.getElementById('raw').checked = state.raw || false;
        document.getElementById('seed').value = state.seed || '';
        document.getElementById('sref').value = state.sref || '';
        document.getElementById('cref').value = state.cref || '';

        // RAWãƒ¢ãƒ¼ãƒ‰å¾©å…ƒ
        if (state.rawMode) localStorage.setItem(KEY_RAW_MODE, state.rawMode);

        // ãƒ©ã‚¸ã‚ªçŠ¶æ…‹åæ˜ 
        const mode = getRawMode();
        document.getElementById('rawStyle').checked = (mode === 'style');
        document.getElementById('rawRaw').checked = (mode === 'raw');

      } catch (e) {
        console.error('çŠ¶æ…‹ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
      }
    }

    // è‡ªå‹•ä¿å­˜ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupAutoSave() {
      const fields = [
        'theme', 'personTemplate', 'composition', 'angle',
        'lighting', 'background', 'ar', 'arCustom', 'stylize',
        'chaos', 'quality', 'raw', 'seed', 'sref', 'cref'
      ];

      fields.forEach((fieldId) => {
        const el = document.getElementById(fieldId);
        if (!el) return;

        el.addEventListener('input', () => {
          saveCurrentState();
          // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã”ã¨ã«å‡ºåŠ›ã‚’è¿½å¾“ã•ã›ãŸã„ãªã‚‰æœ‰åŠ¹åŒ–
          // generatePrompt({ silentToast: true });
        });

        el.addEventListener('change', () => {
          saveCurrentState();
          generatePrompt({ silentToast: true }); // select/checkboxã¯å³åæ˜ 
        });
      });

      // å‡ºåŠ›ã‚¨ãƒ‡ã‚£ã‚¿ã‚‚å¸¸æ™‚ä¿å­˜ï¼ˆã™ã§ã«debounceæ¸ˆã¿ï¼‰
      // ã“ã“ã§ã¯ç‰¹ã«è¿½åŠ ã—ãªã„
    }
  </script>
</body>
</html>
